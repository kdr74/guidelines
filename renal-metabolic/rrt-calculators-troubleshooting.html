<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RRT Interactive Troubleshooting Tool - UHBW ICU</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --nhs-blue: #005EB8;
            --nhs-dark-blue: #003087;
            --nhs-green: #007F3B;
            --nhs-red: #DA291C;
            --nhs-orange: #ED8B00;
            --nhs-grey: #425563;
            --light-bg: #F0F4F5;
            --text: #212B32;
        }
        
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: var(--light-bg);
            color: var(--text);
            line-height: 1.5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: var(--nhs-blue);
            color: white;
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        header p {
            font-size: 15px;
            opacity: 0.95;
        }
        
        .patient-params {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid var(--nhs-blue);
        }
        
        .patient-params h2 {
            color: var(--nhs-blue);
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .tool-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tool-card h2 {
            color: var(--nhs-blue);
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .tool-card h3 {
            color: var(--nhs-blue);
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--nhs-grey);
            font-size: 14px;
        }
        
        input[type="number"],
        input[type="datetime-local"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #d8dde6;
            border-radius: 4px;
            font-size: 15px;
            transition: border-color 0.2s;
        }
        
        input[type="number"]:focus,
        input[type="datetime-local"]:focus,
        select:focus {
            outline: none;
            border-color: var(--nhs-blue);
        }
        
        button {
            background: var(--nhs-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button:hover {
            background: var(--nhs-dark-blue);
        }
        
        button.secondary {
            background: var(--nhs-grey);
            padding: 8px 16px;
            font-size: 14px;
        }
        
        button.danger {
            background: var(--nhs-red);
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .result.success {
            background: #e8f5e9;
            border-left: 4px solid var(--nhs-green);
            color: #1b5e20;
        }
        
        .result.warning {
            background: #fff3e0;
            border-left: 4px solid var(--nhs-orange);
            color: #e65100;
        }
        
        .result.danger {
            background: #ffebee;
            border-left: 4px solid var(--nhs-red);
            color: #b71c1c;
        }
        
        .result.info {
            background: #e3f2fd;
            border-left: 4px solid var(--nhs-blue);
            color: #01579b;
        }
        
        .alert {
            background: #ffebee;
            border-left: 4px solid var(--nhs-red);
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-weight: 600;
            color: var(--nhs-red);
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin: 20px 0;
            border-bottom: 2px solid var(--light-bg);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            background: white;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--nhs-grey);
            transition: all 0.2s;
        }
        
        .tab:hover {
            background: var(--light-bg);
        }
        
        .tab.active {
            color: var(--nhs-blue);
            border-bottom-color: var(--nhs-blue);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin: 15px 0;
        }
        
        th {
            background: var(--nhs-blue);
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        tbody tr:nth-child(even) {
            background: var(--light-bg);
        }
        
        .quick-ref table {
            font-size: 12px;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .two-column,
            .three-column {
                grid-template-columns: 1fr;
            }
        }
        
        .data-table {
            width: 100%;
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .data-table table {
            font-size: 11px;
        }
        
        .data-table th {
            background: var(--nhs-blue);
            padding: 8px 5px;
            white-space: nowrap;
        }
        
        .data-table td {
            padding: 8px 5px;
        }
        
        .data-table input {
            width: 100%;
            padding: 5px;
            font-size: 11px;
            border: 1px solid #ddd;
        }
        
        #trend-chart {
            width: 100%;
            height: 300px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .patient-params {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid var(--nhs-blue);
        }
        
        .patient-params h2 {
            color: var(--nhs-blue);
            font-size: 18px;
            margin-bottom: 12px;
        }
        
        .recommendations {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid var(--nhs-blue);
        }
        
        .recommendations h3 {
            color: var(--nhs-blue);
            margin-bottom: 15px;
        }
        
        .recommendation-item {
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #ddd;
        }
        
        .recommendation-item.critical {
            background: #ffebee;
            border-left-color: var(--nhs-red);
        }
        
        .recommendation-item.warning {
            background: #fff3e0;
            border-left-color: var(--nhs-orange);
        }
        
        .recommendation-item.info {
            background: #e3f2fd;
            border-left-color: var(--nhs-blue);
        }
        
        .calculation-display {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        
        .calculation-display strong {
            color: var(--nhs-blue);
        }
        
        footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--nhs-grey);
            font-size: 13px;
        }
        
        footer a {
            color: var(--nhs-blue);
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        .sodium-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .sodium-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .recommendation-box {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            min-height: 200px;
        }
        
        .recommendation-box h3 {
            color: var(--nhs-blue);
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .recommendation-box .placeholder {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 40px 20px;
        }
        
        /* ===== COMPREHENSIVE MOBILE RESPONSIVE STYLES ===== */
        
        /* Responsive grid layouts */
        @media (max-width: 768px) {
            /* Patient Parameters - stack on mobile */
            .patient-row-3col {
                grid-template-columns: 1fr !important;
            }
            
            .patient-row-5col {
                grid-template-columns: 1fr 1fr !important; /* 2 columns on mobile */
                font-size: 12px !important;
            }
            
            /* RRT boxes - stack on mobile */
            .rrt-boxes-3col {
                grid-template-columns: 1fr !important;
            }
        }
        
        @media (max-width: 480px) {
            /* Very small screens - all single column */
            .patient-row-5col {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Mobile viewport configuration */
        @media (max-width: 768px) {
            /* Container adjustments */
            .container {
                padding: 10px;
            }
            
            /* Header adjustments */
            header h1 {
                font-size: 22px;
            }
            
            header p {
                font-size: 13px;
            }
            
            /* Patient params cards */
            .patient-params {
                padding: 15px;
            }
            
            .patient-params h2 {
                font-size: 18px;
            }
            
            /* Tool cards */
            .tool-card {
                padding: 15px;
            }
            
            .tool-card h2 {
                font-size: 18px;
            }
            
            .tool-card h3 {
                font-size: 14px;
            }
            
            /* Tabs - make scrollable on mobile */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                flex-wrap: nowrap;
                gap: 2px;
                margin: 15px -10px;
                padding: 0 10px;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 13px;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            /* Tables - make scrollable horizontally */
            .data-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 15px -15px;
                padding: 0 15px;
            }
            
            table {
                font-size: 12px;
                min-width: 100%;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 11px;
            }
            
            /* Tools grid - single column on mobile */
            .tools-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* Buttons */
            button {
                font-size: 14px;
                padding: 10px 20px;
            }
            
            button.secondary {
                font-size: 13px;
                padding: 8px 14px;
            }
            
            /* Form inputs */
            input[type="number"],
            input[type="datetime-local"],
            select {
                font-size: 14px;
                padding: 8px 10px;
            }
            
            label {
                font-size: 13px;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            header h1 {
                font-size: 18px;
            }
            
            header p {
                font-size: 12px;
            }
            
            .patient-params {
                padding: 12px;
            }
            
            .tool-card {
                padding: 12px;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>RRT Interactive Troubleshooting Tool</h1>
        <p>Quick Reference Calculators & Protocols | UHBW Adult Intensive Care</p>
    </header>
    
    <div class="container">
        <div class="alert">
            <strong>‚ö†Ô∏è Clinical Tool:</strong> This tool supplements clinical judgement. Always refer to the complete RRT guidelines for detailed protocols and discuss complex cases with senior staff.
        </div>
        
        <!-- README / INTRODUCTION - COLLAPSIBLE -->
        <div class="tool-card" style="margin: 20px 0; border-left: 5px solid var(--nhs-green);">
            <h2 style="color: var(--nhs-green); cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleReadme()">
                <span>üìñ About This Tool</span>
                <span id="readme-toggle" style="font-size: 20px;">‚ñº</span>
            </h2>
            <div id="readme-content" style="display: none;">
            <p style="margin-bottom: 15px;">This interactive troubleshooting tool provides rapid access to RRT calculations, protocols, and decision support. It includes:</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0;">
                <div>
                    <strong style="color: var(--nhs-blue);">üîß Troubleshooting</strong>
                    <p style="font-size: 14px; margin: 5px 0;">Real-time data entry with automated analysis of trends, filter clotting detection, and intelligent recommendations for RRT adjustments.</p>
                </div>
                <div>
                    <strong style="color: var(--nhs-blue);">üíß Blood/Dialysate Flows</strong>
                    <p style="font-size: 14px; margin: 5px 0;">Calculate optimal blood and dialysate flow rates based on patient weight and desired clearance targets.</p>
                </div>
                <div>
                    <strong style="color: var(--nhs-blue);">üíä Calcium Dosing</strong>
                    <p style="font-size: 14px; margin: 5px 0;">Automated calcium infusion calculations for citrate anticoagulation with real-time adjustment recommendations.</p>
                </div>
                <div>
                    <strong style="color: var(--nhs-blue);">üß™ Citrate Dosing</strong>
                    <p style="font-size: 14px; margin: 5px 0;">Citrate concentration calculations with safety checks for metabolic complications and filter performance.</p>
                </div>
                <div>
                    <strong style="color: var(--nhs-blue);">‚ö° Sodium Correction</strong>
                    <p style="font-size: 14px; margin: 5px 0;"><strong>NEW V3.0:</strong> Comprehensive sodium correction calculator with correction-rate-first approach, automatic gradient calculation, SenseCheck verification table, and detailed prescriptions for safe dysnatraemia management.</p>
                </div>
                <div>
                    <strong style="color: var(--nhs-blue);">üî¨ Acid-Base</strong>
                    <p style="font-size: 14px; margin: 5px 0;">Manage metabolic acidosis and alkalosis with bicarbonate calculations and dialysate selection guidance.</p>
                </div>
                <div>
                    <strong style="color: var(--nhs-blue);">üìä Ca Ratio Calculator</strong>
                    <p style="font-size: 14px; margin: 5px 0;">Calculate calcium-to-citrate ratios for troubleshooting citrate anticoagulation issues.</p>
                </div>
            </div>
            
            <div style="background: rgba(0,126,59,0.1); padding: 15px; border-radius: 4px; margin-top: 15px;">
                <p style="margin: 0; font-size: 14px;"><strong>üí° Tip:</strong> Enter patient parameters at the top (weight, height, sex, filter type) - these will automatically populate across all calculators. Use the troubleshooting tab to log serial data and detect trends.</p>
            </div>
            
            <div style="background: rgba(218,41,28,0.1); padding: 15px; border-radius: 4px; margin-top: 10px;">
                <p style="margin: 0; font-size: 14px;"><strong>‚ö†Ô∏è Safety:</strong> All dialysate modifications require <strong>consultant approval</strong> and <strong>Band 6+ nurse second-check</strong>. Maximum safe sodium correction: 8-10 mmol/L per 24 hours.</p>
            </div>
            </div> <!-- End of readme-content -->
        </div>
        
        <!-- PATIENT PARAMETERS SECTION -->
        <div class="patient-params">
            <h2>Patient Parameters</h2>
            
            <!-- Row 1: ABW, Height, Sex (3-column) -->
            <div class="patient-row-3col" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group" style="margin: 0;">
                    <label for="abw">Actual Body Weight (kg)</label>
                    <input type="number" id="abw" placeholder="e.g., 85" min="30" max="300" step="0.1" onchange="calculateIBWAuto()">
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label for="height">Height (cm)</label>
                    <input type="number" id="height" placeholder="e.g., 175" min="100" max="250" onchange="calculateIBWAuto()">
                </div>
                
                <div class="form-group" style="margin: 0;">
                    <label for="sex">Sex</label>
                    <select id="sex" onchange="calculateIBWAuto()">
                        <option value="">Select...</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>
            
            <!-- CALCULATED PARAMETERS - Single row, 5 columns -->
            <div style="padding: 15px; background: rgba(0,94,184,0.05); border-radius: 4px; border: 1px solid rgba(0,94,184,0.2);">
                <div class="patient-row-5col" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 15px; font-size: 13px;">
                    <div style="text-align: center;">
                        <div style="color: #666; margin-bottom: 5px; font-weight: 500;">IBW</div>
                        <div id="ibw-display" style="color: var(--nhs-blue); font-weight: bold; font-size: 15px;">‚Äî</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; margin-bottom: 5px; font-weight: 500;">BMI</div>
                        <div id="bmi-display" style="color: var(--nhs-blue); font-weight: bold; font-size: 15px;">‚Äî</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; margin-bottom: 5px; font-weight: 500;">BSA</div>
                        <div id="bsa-display" style="color: var(--nhs-blue); font-weight: bold; font-size: 15px;">‚Äî</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; margin-bottom: 5px; font-weight: 500;">Est. Blood Volume</div>
                        <div id="blood-volume-display" style="color: var(--nhs-blue); font-weight: bold; font-size: 15px;">‚Äî</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; margin-bottom: 5px; font-weight: 500;">Est. TBW</div>
                        <div id="tbw-display" style="color: var(--nhs-blue); font-weight: bold; font-size: 15px;">‚Äî</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- RRT PARAMETERS SECTION -->
        <div class="patient-params" style="margin-top: 20px;">
            <h2>RRT Parameters</h2>
            
            <!-- 3-column layout for Treatment, Filter, Vascath boxes -->
            <div class="rrt-boxes-3col" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <!-- TREATMENT BOX -->
                <div style="background: rgba(0,127,59,0.05); border: 1px solid rgba(0,127,59,0.2); border-radius: 4px; padding: 12px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 14px; color: var(--nhs-green); font-weight: 600;">Treatment</h3>
                    <div class="form-group" style="margin: 0 0 10px 0;">
                        <label for="modality">Modality</label>
                        <select id="modality">
                            <option value="">Select...</option>
                            <option value="cvvhd">CVV-HD</option>
                            <option value="cvvhdf">CVV-HDF</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label for="anticoag">Anticoagulation</label>
                        <select id="anticoag" onchange="updateAnticoagDisplays()">
                            <option value="">Select...</option>
                            <option value="citrate">Citrate (Ci-Ca¬Æ)</option>
                            <option value="heparin">Heparin</option>
                            <option value="epoprostenol">Epoprostenol</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                </div>
                
                <!-- FILTER BOX -->
                <div style="background: rgba(0,94,184,0.05); border: 1px solid rgba(0,94,184,0.2); border-radius: 4px; padding: 12px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 14px; color: var(--nhs-blue); font-weight: 600;">Filter</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label for="filter-changed">Last Changed</label>
                            <input type="datetime-local" id="filter-changed" onchange="calculateFilterAge(); calculateVascathAge();">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="filter-type">Type</label>
                            <select id="filter-type">
                                <option value="">Select...</option>
                                <option value="emic2">EMiC2 (40kDa)</option>
                                <option value="av1000s">AV1000s (20kDa)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Age</label>
                        <div id="filter-age-display" style="padding: 10px; background: #f0f0f0; border-radius: 4px; font-weight: 600; text-align: center;">
                            ‚Äî
                        </div>
                    </div>
                </div>
                
                <!-- VASCATH BOX -->
                <div style="background: rgba(237,139,0,0.05); border: 1px solid rgba(237,139,0,0.2); border-radius: 4px; padding: 12px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 14px; color: var(--nhs-orange); font-weight: 600;">Vascath</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label for="vascath-site">Site</label>
                            <select id="vascath-site" onchange="calculateVascathAge();">
                                <option value="">Select...</option>
                                <option value="ijv-right">Internal Jugular (Right)</option>
                                <option value="ijv-left">Internal Jugular (Left)</option>
                                <option value="femoral-right">Femoral (Right)</option>
                                <option value="femoral-left">Femoral (Left)</option>
                                <option value="subclavian-right">Subclavian (Right)</option>
                                <option value="subclavian-left">Subclavian (Left)</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="vascath-size">Size</label>
                            <select id="vascath-size">
                                <option value="">Select...</option>
                                <option value="11F">11F</option>
                                <option value="12F">12F</option>
                                <option value="13F">13F</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="vascath-inserted">Inserted</label>
                            <input type="datetime-local" id="vascath-inserted" onchange="calculateVascathAge();">
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Age</label>
                        <div id="vascath-age-display" style="padding: 10px; background: #f0f0f0; border-radius: 4px; font-weight: 600; text-align: center;">
                            ‚Äî
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('flows')">üíß Blood/Dialysate Flows</button>
            <button class="tab" onclick="showTab('citrate')">üß™ Citrate Dosing</button>
            <button class="tab" onclick="showTab('calcium')">üíä Calcium Dosing</button>
            <button class="tab" onclick="showTab('ratios')">üìä Ca Ratio Calculator</button>
            <button class="tab" onclick="showTab('acidbase')">üî¨ Acid-Base</button>
            <button class="tab" onclick="showTab('sodium')">‚ö° Sodium Correction</button>
            <button class="tab" onclick="showTab('access')">ü©∫ Access & Filter Issues</button>
            <button class="tab" onclick="showTab('troubleshooting')">üîß Troubleshooting</button>
        </div>
        
        <!-- Tab 6.5: ACCESS & FILTER ISSUES -->
        <div id="access-tab" class="tab-content">
            <div class="tool-card">
                <h2>Access & Filter Issues</h2>
                
                <!-- RRT PARAMETERS TABLE -->
                <div>
                    <h3 style="color: var(--nhs-blue);">RRT Parameters Monitoring</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Add rows to track trends over time. Access, filter, and anticoagulation information populated from Patient & RRT Parameters.</p>
                    
                    <div class="data-table" style="overflow-x: auto;">
                        <table id="access-monitoring-table" style="min-width: 1200px;">
                            <thead>
                                <tr>
                                    <th rowspan="2" style="vertical-align: middle; min-width: 140px; background: #333; color: white;">Date/Time</th>
                                    <th colspan="3" style="background: #005EB8; color: white;">Pressures</th>
                                    <th colspan="2" style="background: #007F3B; color: white;">Fluid Balance</th>
                                    <th colspan="3" style="background: #ED8B00; color: white;">Haematology</th>
                                    <th rowspan="2" style="vertical-align: middle; min-width: 120px; background: #333; color: white;">Visible Clotting/Clogging</th>
                                    <th rowspan="2" style="vertical-align: middle; background: #333; color: white;">Actions</th>
                                </tr>
                                <tr>
                                    <th style="background: rgba(0,94,184,0.7); color: white;">Access (mmHg)</th>
                                    <th style="background: rgba(0,94,184,0.7); color: white;">Return (mmHg)</th>
                                    <th style="background: rgba(0,94,184,0.7); color: white;">TMP (mmHg)</th>
                                    <th style="background: rgba(0,127,59,0.7); color: white;">Today (L)</th>
                                    <th style="background: rgba(0,127,59,0.7); color: white;">Total ICU (L)</th>
                                    <th style="background: rgba(237,139,0,0.7); color: white;">Hct (%)</th>
                                    <th style="background: rgba(237,139,0,0.7); color: white;">iCa (filter)</th>
                                    <th style="background: rgba(237,139,0,0.7); color: white;">Anti-Xa</th>
                                </tr>
                            </thead>
                            <tbody id="access-monitoring-body">
                                <!-- Rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <button onclick="addAccessMonitoringRow()" class="btn" style="margin-top: 15px; background: var(--nhs-blue); color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                        + Add Row
                    </button>
                </div>
                
                <!-- ALERTS AND MANAGEMENT OUTPUT (2-column layout) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                    <!-- LEFT: ALERTS -->
                    <div id="access-alerts-output">
                        <!-- Alerts will appear here -->
                    </div>
                    
                    <!-- RIGHT: COLLATED MANAGEMENT RECOMMENDATIONS -->
                    <div id="access-collated-output">
                        <!-- Collated recommendations will appear here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab 7: TROUBLESHOOTING (moved to end) -->
        <div id="troubleshooting-tab" class="tab-content">
            <div class="tool-card">
                <h2>Current RRT Settings & Patient Data Entry</h2>
                
                <div class="data-table">
                    <table id="monitoring-table">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Blood Flow<br>(mL/min)</th>
                                <th>Dialysate<br>(L/h)</th>
                                <th>Citrate<br>(mmol/L)</th>
                                <th>Ca Infusion<br>(mmol/L/h)</th>
                                <th>Total Ca<br>(mmol/L)</th>
                                <th>iCa<br>(mmol/L)</th>
                                <th>pH</th>
                                <th>HCO‚ÇÉ‚Åª<br>(mmol/L)</th>
                                <th>Urea<br>(mmol/L)</th>
                                <th>Creat<br>(Œºmol/L)</th>
                                <th>Na‚Å∫<br>(mmol/L)</th>
                                <th>Cl‚Åª<br>(mmol/L)</th>
                                <th>Fluid Removed<br>(L)</th>
                                <th>Fluid Balance<br>(L)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="monitoring-tbody">
                            <tr>
                                <td><input type="datetime-local" id="datetime-0"></td>
                                <td><input type="number" id="bloodflow-0" min="40" max="200" step="1"></td>
                                <td><input type="number" id="dialysate-0" min="0" max="4" step="0.1"></td>
                                <td><input type="number" id="citrate-0" min="0" max="10" step="0.1"></td>
                                <td><input type="number" id="cainfusion-0" min="0" max="5" step="0.1"></td>
                                <td><input type="number" id="totalca-0" min="1" max="4" step="0.01"></td>
                                <td><input type="number" id="ica-0" min="0.5" max="2" step="0.01"></td>
                                <td><input type="number" id="ph-0" min="6.8" max="7.8" step="0.01"></td>
                                <td><input type="number" id="hco3-0" min="5" max="50" step="0.1"></td>
                                <td><input type="number" id="urea-0" min="0" max="50" step="0.1"></td>
                                <td><input type="number" id="creat-0" min="0" max="1000" step="1"></td>
                                <td><input type="number" id="na-0" min="100" max="200" step="1"></td>
                                <td><input type="number" id="cl-0" min="70" max="150" step="1"></td>
                                <td><input type="number" id="removed-0" min="0" max="50" step="0.1"></td>
                                <td><input type="number" id="balance-0" min="-20" max="20" step="0.1"></td>
                                <td><button class="secondary danger" onclick="removeRow(this)">Remove</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px;">
                    <button onclick="addMonitoringRow()">+ Add New Row</button>
                    <button onclick="analyseData()" style="margin-left: 10px; background: var(--nhs-green);">üìä Analysis</button>
                </div>
            </div>
            
            <div id="recommendations-container" style="display: none;">
                <div class="recommendations">
                    <h3>Clinical Recommendations</h3>
                    <div id="recommendations-content"></div>
                </div>
            </div>
            
            <div id="trend-chart-container" style="display: none;">
                <div class="tool-card">
                    <h2>Parameter Trends</h2>
                    <canvas id="trend-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Tab 1: Blood & Dialysate Flows -->
        <!-- Tab 1: BLOOD/DIALYSATE FLOWS (now first and active) -->
        <div id="flows-tab" class="tab-content active">
            <div class="tool-card">
                <h2>Blood & Dialysate Flow Calculator</h2>
                
                <!-- Weight Selection Switch -->
                <div style="background: rgba(0,94,184,0.1); padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">Weight Basis for Calculations:</label>
                    <div style="display: flex; gap: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="weight-basis" id="use-ibw" value="ibw" checked onchange="updateFlowCalculations()">
                            <span style="margin-left: 8px; font-weight: 500;">Use Ideal Body Weight (IBW)</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="weight-basis" id="use-abw" value="abw" onchange="updateFlowCalculations()">
                            <span style="margin-left: 8px; font-weight: 500;">Use Actual Body Weight (ABW)</span>
                        </label>
                    </div>
                    <div id="selected-weight-display" style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 14px;">
                        <strong>Selected Weight:</strong> <span id="weight-value">‚Äî</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px;">
                    <!-- LEFT: Default and Enhanced Recommendations -->
                    <div>
                        <h3 style="color: var(--nhs-blue); margin-bottom: 15px;">Recommended Flow Rates</h3>
                        <div id="flow-recommendations">
                            <p style="text-align: center; color: #666; padding: 40px;">Enter patient weight, height, and sex at the top of the page to calculate flows</p>
                        </div>
                    </div>
                    
                    <!-- RIGHT: Custom Calculator -->
                    <div class="tool-card" style="background: rgba(0,126,59,0.05); border-left: 5px solid var(--nhs-green);">
                        <h3 style="color: var(--nhs-green); margin-bottom: 15px;">Custom Flow Calculator</h3>
                        <div class="form-group">
                            <label>Blood Flow (mL/min)</label>
                            <input type="number" id="custom-blood-flow" min="40" max="200" step="1" placeholder="e.g., 120" oninput="calculateCustomFlows()">
                        </div>
                        <div class="form-group">
                            <label>Dialysate Flow (mL/h)</label>
                            <input type="number" id="custom-dialysate-flow" min="500" max="4000" step="100" placeholder="e.g., 2000" oninput="calculateCustomFlows()">
                        </div>
                        <div id="custom-flow-results" style="margin-top: 15px;">
                            <!-- Results will appear here -->
                        </div>
                        <div id="custom-flow-notes" style="margin-top: 15px; font-size: 13px;">
                            <!-- Notes about benefits/risks will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab 2: Calcium Dosing -->
        <div id="calcium-tab" class="tab-content">
            <div class="tools-grid">
                <div class="tool-card">
                    <h2>Calcium Chloride Dose Calculator</h2>
                    <div class="form-group">
                        <label for="ica-systemic">Systemic (Patient) iCa¬≤‚Å∫ (mmol/L)</label>
                        <input type="number" id="ica-systemic" placeholder="e.g., 1.05" min="0.5" max="2.0" step="0.01">
                        <p class="help-text">Target range: 1.12-1.20 mmol/L</p>
                    </div>
                    <button onclick="calculateCalcium()">Calculate Dose & Action</button>
                    <div id="calcium-result" class="result"></div>
                </div>
                
                <div class="tool-card">
                    <h2>Quick Reference: Calcium Management</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Systemic iCa¬≤‚Å∫</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #FFE5E5;">
                                <td>&lt; 0.80</td>
                                <td><strong>üö® Give 10mL 10% CaCl‚ÇÇ + ‚Üë 0.4 mmol/L + Inform clinician</strong></td>
                            </tr>
                            <tr style="background: #FFE5E5;">
                                <td>0.80-0.99</td>
                                <td><strong>‚Üë Increase by 0.4 mmol/L + Inform clinician</strong></td>
                            </tr>
                            <tr style="background: #FFF4E5;">
                                <td>1.00-1.11</td>
                                <td>Increase by 0.2 mmol/L</td>
                            </tr>
                            <tr style="background: #F0FFF4;">
                                <td>1.12-1.20</td>
                                <td><strong>Target range - no change</strong></td>
                            </tr>
                            <tr style="background: #FFF4E5;">
                                <td>1.21-1.35</td>
                                <td>Decrease by 0.2 mmol/L</td>
                            </tr>
                            <tr style="background: #FFE5E5;">
                                <td>&gt; 1.35</td>
                                <td><strong>‚Üì Decrease by 0.4 mmol/L + Inform clinician</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="help-text" style="margin-top: 15px;"><strong>Pre-treatment:</strong> If iCa¬≤‚Å∫ <1.11, give calcium chloride 14.7% 10mL (10mmol) in 50mL NaCl 0.9% over 30min before starting CRRT</p>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: Citrate Dosing -->
        <div id="citrate-tab" class="tab-content">
            <div class="tools-grid">
                <div class="tool-card">
                    <h2>Citrate Dose Calculator</h2>
                    <div class="form-group">
                        <label for="ica-circuit">Circuit (Post-filter) iCa¬≤‚Å∫ (mmol/L)</label>
                        <input type="number" id="ica-circuit" placeholder="e.g., 0.30" min="0.1" max="1.0" step="0.01">
                        <p class="help-text">Target range: 0.25-0.34 mmol/L</p>
                    </div>
                    <button onclick="calculateCitrate()">Calculate Dose Adjustment</button>
                    <div id="citrate-result" class="result"></div>
                </div>
                
                <div class="tool-card">
                    <h2>Quick Reference: Citrate Management</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Circuit iCa¬≤‚Å∫</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #FFE5E5;">
                                <td>&lt; 0.20</td>
                                <td><strong>‚Üì Decrease by 0.2 mmol/L + Inform clinician</strong></td>
                            </tr>
                            <tr style="background: #FFF4E5;">
                                <td>0.20-0.24</td>
                                <td>Decrease by 0.1 mmol/L</td>
                            </tr>
                            <tr style="background: #F0FFF4;">
                                <td>0.25-0.34</td>
                                <td><strong>Target range - no change</strong></td>
                            </tr>
                            <tr style="background: #FFF4E5;">
                                <td>0.35-0.40</td>
                                <td>Increase by 0.1 mmol/L</td>
                            </tr>
                            <tr style="background: #FFE5E5;">
                                <td>&gt; 0.40</td>
                                <td><strong>‚Üë Increase by 0.2 mmol/L + Inform clinician</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="help-text" style="margin-top: 15px;"><strong>Sampling:</strong> First sample 5 minutes after starting CVVHD, then every 8 hours. Sample from blue port on circuit (not patient).</p>
                </div>
            </div>
        </div>
        
        <!-- Tab 4: Sodium Correction V3.0 -->
        <div id="sodium-tab" class="tab-content">
            <div class="alert" style="margin-bottom: 20px; background: #FFF4E5; border-left: 5px solid var(--nhs-orange);">
                <strong>‚ö†Ô∏è CRITICAL SAFETY:</strong> Consultant approval + Band 6+ nurse second-check required. Maximum safe correction: 8-10 mmol/L per 24 hours. Modified dialysate bags must be used within 24 hours.
            </div>
            
            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Patient weight, height, and sex from top of page will be used automatically for TBW and blood volume calculations.</p>
            
            <!-- 3-COLUMN INPUT LAYOUT -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <!-- COLUMN 1: Patient Parameters -->
                <div class="tool-card" style="margin: 0;">
                    <h2>Patient Parameters</h2>
                    <div class="form-group">
                        <label for="na-patient-na">Patient Serum Sodium (mmol/L)</label>
                        <input type="number" id="na-patient-na" placeholder="e.g., 165" min="100" max="200" step="1" oninput="autoRecalculateSodium()">
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Normal range: 135-145 mmol/L</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="na-correction-rate">Target Rate of Sodium Correction</label>
                        <select id="na-correction-rate" onchange="autoRecalculateSodium()">
                            <option value="">Select...</option>
                            <option value="4-6">4-6 mmol/L per 24h (Very cautious)</option>
                            <option value="6-8">6-8 mmol/L per 24h (Cautious - recommended)</option>
                            <option value="8-10">8-10 mmol/L per 24h (Standard)</option>
                            <option value="10-12">10-12 mmol/L per 24h (Aggressive)</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Maximum safe: 8-10 mmol/L per 24h</p>
                    </div>
                </div>
                
                <!-- COLUMN 2: Dialysate Selection -->
                <div class="tool-card" style="margin: 0;">
                    <h2>Dialysate Selection</h2>
                    
                    <div class="form-group">
                        <label>Anticoagulation</label>
                        <div id="sodium-anticoag-display" style="padding: 8px; background: rgba(0,94,184,0.1); border-radius: 4px; font-size: 14px; font-weight: 500;">
                            From Patient & RRT Parameters
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="na-dialysate">Base Dialysate</label>
                        <select id="na-dialysate" onchange="autoRecalculateSodium()">
                            <option value="">Select...</option>
                            <option value="Ci-Ca K4">Ci-Ca K4 (Na 133, K 4)</option>
                            <option value="Ci-Ca K2">Ci-Ca K2 (Na 133, K 2)</option>
                            <option value="multiBic 2K">MultiBic 2K (Na 140, K 2)</option>
                            <option value="multiBic 4K">MultiBic 4K (Na 140, K 4)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="na-additive">Additive Fluid</label>
                        <select id="na-additive" onchange="autoRecalculateSodium()">
                            <option value="">Select...</option>
                            <option value="sterile-water">Sterile Water (dilution)</option>
                            <option value="0.9%">0.9% NaCl (Normal Saline)</option>
                            <option value="1.26%">1.26% NaCl</option>
                            <option value="1.4%">1.4% NaCl</option>
                            <option value="5%">5% NaCl</option>
                            <option value="30%">30% NaCl</option>
                        </select>
                    </div>
                </div>
                
                <!-- COLUMN 3: RRT Parameters -->
                <div class="tool-card" style="margin: 0;">
                    <h2>RRT Parameters</h2>
                    <div class="form-group">
                        <label for="na-blood-flow">Blood Flow Rate (mL/min)</label>
                        <input type="number" id="na-blood-flow" placeholder="e.g., 150" min="50" max="250" step="10" value="150" oninput="autoRecalculateSodium()">
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Typical: 100-200 mL/min</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="na-dialysate-flow">Dialysate Flow Rate (mL/h)</label>
                        <input type="number" id="na-dialysate-flow" placeholder="e.g., 2000" min="500" max="5000" step="100" value="2000" oninput="autoRecalculateSodium()">
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Typical: 1500-2500 mL/h</p>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 25px 0;">
                <button onclick="calculateSodiumCorrectionV3()" style="padding: 15px 40px; font-size: 16px; background: var(--nhs-blue); color: white; border: none; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                    Calculate Dialysate Adjustment
                </button>
            </div>
            
            <div id="sodium-results" style="display: none; margin-top: 20px;">
                <!-- Results will be inserted here by JavaScript -->
            </div>
        </div>
        
        <!-- Tab 5: Acid-Base -->
        <div id="acidbase-tab" class="tab-content">
            <div class="tool-card">
                <h2>Acid-Base Analysis & Management</h2>
                
                <!-- 4-COLUMN INPUT LAYOUT -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 15px; margin-bottom: 20px;">
                    <!-- COLUMN 1: Blood Gas Values -->
                    <div>
                        <h3 style="color: var(--nhs-blue); margin-bottom: 15px; font-size: 16px;">Blood Gas</h3>
                        
                        <div class="form-group">
                            <label for="ab-ph">pH</label>
                            <input type="number" id="ab-ph" placeholder="e.g., 7.32" min="6.5" max="7.8" step="0.01" oninput="calculateAcidBase()">
                        </div>
                        
                        <div class="form-group">
                            <label for="ab-pco2">pCO‚ÇÇ (kPa)</label>
                            <input type="number" id="ab-pco2" placeholder="e.g., 5.5" min="2" max="15" step="0.1" oninput="calculateAcidBase()">
                        </div>
                        
                        <div class="form-group">
                            <label for="ab-be">Base Excess (mmol/L)</label>
                            <input type="number" id="ab-be" placeholder="e.g., -8" min="-30" max="30" step="0.1" oninput="calculateAcidBase()">
                        </div>
                        
                        <div class="form-group">
                            <label for="ab-hco3">Bicarbonate (mmol/L)</label>
                            <input type="number" id="ab-hco3" placeholder="e.g., 18" min="5" max="50" step="0.1" oninput="calculateAcidBase()">
                        </div>
                        
                        <div class="form-group">
                            <label for="ab-lactate">Lactate (mmol/L)</label>
                            <input type="number" id="ab-lactate" placeholder="e.g., 2.5" min="0" max="30" step="0.1" oninput="calculateAcidBase()">
                        </div>
                    </div>
                    
                    <!-- COLUMN 2: Lab Values -->
                    <div>
                        <h3 style="color: var(--nhs-blue); margin-bottom: 15px; font-size: 16px;">Laboratory</h3>
                        
                        <div class="form-group">
                            <label for="ab-na">Sodium (mmol/L)</label>
                            <input type="number" id="ab-na" placeholder="e.g., 140" min="100" max="200" step="1" oninput="calculateAcidBase()">
                        </div>
                        
                        <div class="form-group">
                            <label for="ab-k">Potassium (mmol/L)</label>
                            <input type="number" id="ab-k" placeholder="e.g., 4.5" min="2" max="8" step="0.1" oninput="calculateAcidBase()">
                        </div>
                        
                        <div class="form-group">
                            <label for="ab-cl">Chloride (mmol/L)</label>
                            <input type="number" id="ab-cl" placeholder="e.g., 105" min="70" max="140" step="1" oninput="calculateAcidBase()">
                        </div>
                        
                        <div class="form-group">
                            <label for="ab-glucose">Glucose (mmol/L)</label>
                            <input type="number" id="ab-glucose" placeholder="e.g., 8.5" min="2" max="30" step="0.1" oninput="calculateAcidBase()">
                        </div>
                        
                        <div class="form-group">
                            <label for="ab-albumin">Albumin (g/L)</label>
                            <input type="number" id="ab-albumin" placeholder="e.g., 35" min="10" max="60" step="1" oninput="calculateAcidBase()">
                        </div>
                    </div>
                    
                    <!-- COLUMN 3: RRT Parameters (Full Width) -->
                    <div>
                        <h3 style="color: var(--nhs-blue); margin-bottom: 15px; font-size: 16px;">RRT Parameters</h3>
                        
                        <div class="form-group">
                            <label>Anticoagulation</label>
                            <div id="ab-anticoag-display" style="padding: 8px; background: rgba(0,94,184,0.1); border-radius: 4px; font-size: 14px; font-weight: 500;">
                                From Patient & RRT Parameters
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="ab-clearance">Clearance (mL/kg/h)</label>
                            <input type="number" id="ab-clearance" placeholder="e.g., 25" min="10" max="50" step="1" oninput="calculateAcidBase()">
                        </div>
                        
                        <div class="form-group">
                            <label>Evidence of Citrate Accumulation?</label>
                            <div style="display: flex; gap: 20px; padding-top: 5px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="citrate-accum" id="citrate-yes" value="yes" onchange="calculateAcidBase()" style="margin-right: 5px;">
                                    <span>Yes</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="citrate-accum" id="citrate-no" value="no" onchange="calculateAcidBase()" style="margin-right: 5px;">
                                    <span>No</span>
                                </label>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <div class="form-group">
                                <label for="ab-urea">Urea (mmol/L)</label>
                                <input type="number" id="ab-urea" placeholder="e.g., 15" min="0" max="50" step="0.1" oninput="calculateAcidBase()">
                            </div>
                            <div class="form-group">
                                <label for="ab-urea-trend">Urea Trend</label>
                                <select id="ab-urea-trend" onchange="calculateAcidBase()">
                                    <option value="">Select...</option>
                                    <option value="stable">Stable</option>
                                    <option value="rising">Rising</option>
                                    <option value="falling">Falling</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <div class="form-group">
                                <label for="ab-creatinine">Creatinine (Œºmol/L)</label>
                                <input type="number" id="ab-creatinine" placeholder="e.g., 250" min="0" max="1000" step="1" oninput="calculateAcidBase()">
                            </div>
                            <div class="form-group">
                                <label for="ab-creat-trend">Creatinine Trend</label>
                                <select id="ab-creat-trend" onchange="calculateAcidBase()">
                                    <option value="">Select...</option>
                                    <option value="stable">Stable</option>
                                    <option value="rising">Rising</option>
                                    <option value="falling">Falling</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- RESULTS SECTION -->
                <div id="acidbase-results" style="margin-top: 20px;">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Tab 6: Calcium Ratio Calculator -->
        <div id="ratios-tab" class="tab-content">
            <div class="tool-card">
                <h2>Calcium Analysis & Ratio Calculator</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- LEFT: Inputs -->
                    <div>
                        <h3 style="color: var(--nhs-blue); margin-bottom: 15px;">Laboratory Values</h3>
                        <div class="form-group">
                            <label for="total-ca">Total Serum Calcium (mmol/L)</label>
                            <input type="number" id="total-ca" placeholder="e.g., 2.40" min="1.0" max="4.0" step="0.01" oninput="calculateRatio()">
                            <p class="help-text">From laboratory sample</p>
                        </div>
                        <div class="form-group">
                            <label for="serum-albumin">Serum Albumin (g/L)</label>
                            <input type="number" id="serum-albumin" placeholder="e.g., 35" min="10" max="60" step="1" oninput="calculateRatio()">
                            <p class="help-text">For adjusted calcium calculation</p>
                        </div>
                        <div class="form-group">
                            <label for="ionised-ca">Ionised Calcium (iCa¬≤‚Å∫) (mmol/L)</label>
                            <input type="number" id="ionised-ca" placeholder="e.g., 1.10" min="0.5" max="2.0" step="0.01" oninput="calculateRatio()">
                            <p class="help-text">From arterial sample (simultaneous)</p>
                        </div>
                        
                        <div id="ratio-result" style="margin-top: 20px;"></div>
                    </div>
                    
                    <!-- RIGHT: Visual Calcium Distribution -->
                    <div>
                        <h3 style="color: var(--nhs-blue); margin-bottom: 15px;">Calcium Distribution</h3>
                        <div style="height: 400px; display: flex; align-items: center; justify-content: center;">
                            <canvas id="calcium-bar-chart"></canvas>
                        </div>
                        <div id="calcium-legend" style="margin-top: 15px; font-size: 13px;">
                            <!-- Legend will be populated by JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Citrate Accumulation Warning Signs (below inputs) -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
                    <h3 style="color: var(--nhs-red); margin-bottom: 15px;">‚ö†Ô∏è Citrate Accumulation Warning Signs</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div style="background: rgba(218,41,28,0.1); padding: 15px; border-radius: 4px; text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total:Ionised Ratio</div>
                            <div style="font-size: 20px; font-weight: bold; color: var(--nhs-red);">&gt; 2.25</div>
                            <div style="font-size: 11px; margin-top: 5px;">Critical: &gt;2.5</div>
                        </div>
                        <div style="background: rgba(218,41,28,0.1); padding: 15px; border-radius: 4px; text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Calcium</div>
                            <div style="font-size: 20px; font-weight: bold; color: var(--nhs-red);">&gt; 3.0</div>
                            <div style="font-size: 11px; margin-top: 5px;">mmol/L</div>
                        </div>
                        <div style="background: rgba(218,41,28,0.1); padding: 15px; border-radius: 4px; text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Ca Infusion Rate</div>
                            <div style="font-size: 20px; font-weight: bold; color: var(--nhs-red);">&gt; 2.0</div>
                            <div style="font-size: 11px; margin-top: 5px;">mmol/L/h</div>
                        </div>
                        <div style="background: rgba(218,41,28,0.1); padding: 15px; border-radius: 4px; text-align: center;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Metabolic Acidosis</div>
                            <div style="font-size: 20px; font-weight: bold; color: var(--nhs-red);">Present</div>
                            <div style="font-size: 11px; margin-top: 5px;">with above</div>
                        </div>
                    </div>
                    <div style="background: #FFE5E5; padding: 15px; border-radius: 4px; border-left: 4px solid var(--nhs-red);">
                        <strong>üö® Action Required:</strong> If ALL 4 warning signs present, refer to duty consultant immediately and consider switching anticoagulation mode. Citrate accumulation can lead to hypocalcaemia, metabolic acidosis, and haemodynamic instability.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p><strong>UHBW Adult Intensive Care | RRT Interactive Tool</strong></p>
        <p style="margin-top: 10px;">This tool supplements the comprehensive RRT Guidelines</p>
        <p style="margin-top: 5px;">For detailed protocols, always refer to the complete guideline document</p>
        <p style="margin-top: 15px; font-size: 11px;">Version 2.0 | December 2025 | Based on Guidelines V1.1 (October 2018)</p>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        let monitoringRowCount = 1;
        let trendChart = null;
        
        // Tab switching
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Find and activate the clicked tab button
            const clickedButton = Array.from(tabButtons).find(btn => 
                btn.getAttribute('onclick')?.includes(tabName)
            );
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
        }
        
        // Toggle README visibility
        function toggleReadme() {
            const content = document.getElementById('readme-content');
            const toggle = document.getElementById('readme-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }
        
        // Automatic IBW calculation
        function calculateIBWAuto() {
            const abw = parseFloat(document.getElementById('abw').value);
            const height = parseFloat(document.getElementById('height').value);
            const sex = document.getElementById('sex').value;
            
            if (!abw || !height || !sex) {
                document.getElementById('ibw-display').innerHTML = '<strong style="font-size: 13px;">Enter weight, height & sex</strong>';
                document.getElementById('blood-volume-display').innerHTML = '<strong style="font-size: 13px;">Enter weight, height & sex</strong>';
                document.getElementById('tbw-display').innerHTML = '<strong style="font-size: 13px;">Enter weight, height & sex</strong>';
                return;
            }
            
            // Calculate IBW
            let ibw;
            if (sex === 'male') {
                const heightInches = height / 2.54;
                ibw = 50 + 2.3 * (heightInches - 60);
            } else {
                const heightInches = height / 2.54;
                ibw = 45.5 + 2.3 * (heightInches - 60);
            }
            ibw = Math.max(ibw, 35);
            
            // Calculate Blood Volume using Nadler's formula
            const heightMetres = height / 100;
            let bloodVolume;
            if (sex === 'male') {
                bloodVolume = (0.3669 * Math.pow(heightMetres, 3)) + (0.03219 * abw) + 0.6041;
            } else {
                bloodVolume = (0.3561 * Math.pow(heightMetres, 3)) + (0.03308 * abw) + 0.1833;
            }
            
            // Calculate Total Body Water
            const tbw = sex === 'male' ? 0.6 * abw : 0.5 * abw;
            
            // Calculate BMI
            const heightMetresForBMI = height / 100;
            const bmi = abw / (heightMetresForBMI * heightMetresForBMI);
            
            // Calculate BSA using Mosteller formula
            const bsa = Math.sqrt((abw * height) / 3600);
            
            // Display all values in single line format
            document.getElementById('ibw-display').innerHTML = `<strong>${ibw.toFixed(1)} kg</strong>`;
            document.getElementById('bmi-display').innerHTML = `<strong>${bmi.toFixed(1)} kg/m¬≤</strong>`;
            document.getElementById('bsa-display').innerHTML = `<strong>${bsa.toFixed(2)} m¬≤</strong>`;
            document.getElementById('blood-volume-display').innerHTML = `<strong>${bloodVolume.toFixed(2)} L</strong>`;
            document.getElementById('tbw-display').innerHTML = `<strong>${tbw.toFixed(1)} L</strong>`;
            
            // Update flow calculations if on flows tab
            updateFlowCalculations();
        }
        
        // Add monitoring row
        function addMonitoringRow() {
            const tbody = document.getElementById('monitoring-tbody');
            const newRow = document.createElement('tr');
            const rowId = monitoringRowCount;
            
            newRow.innerHTML = `
                <td><input type="datetime-local" id="datetime-${rowId}"></td>
                <td><input type="number" id="bloodflow-${rowId}" min="40" max="200" step="1"></td>
                <td><input type="number" id="dialysate-${rowId}" min="0" max="4" step="0.1"></td>
                <td><input type="number" id="citrate-${rowId}" min="0" max="10" step="0.1"></td>
                <td><input type="number" id="cainfusion-${rowId}" min="0" max="5" step="0.1"></td>
                <td><input type="number" id="totalca-${rowId}" min="1" max="4" step="0.01"></td>
                <td><input type="number" id="ica-${rowId}" min="0.5" max="2" step="0.01"></td>
                <td><input type="number" id="ph-${rowId}" min="6.8" max="7.8" step="0.01"></td>
                <td><input type="number" id="hco3-${rowId}" min="5" max="50" step="0.1"></td>
                <td><input type="number" id="urea-${rowId}" min="0" max="50" step="0.1"></td>
                <td><input type="number" id="creat-${rowId}" min="0" max="1000" step="1"></td>
                <td><input type="number" id="na-${rowId}" min="100" max="200" step="1"></td>
                <td><input type="number" id="cl-${rowId}" min="70" max="150" step="1"></td>
                <td><input type="number" id="removed-${rowId}" min="0" max="50" step="0.1"></td>
                <td><input type="number" id="balance-${rowId}" min="-20" max="20" step="0.1"></td>
                <td><button class="secondary danger" onclick="removeRow(this)">Remove</button></td>
            `;
            
            tbody.appendChild(newRow);
            monitoringRowCount++;
        }
        
        // Remove monitoring row
        function removeRow(button) {
            const row = button.closest('tr');
            row.remove();
        }
        
        // Collect all monitoring data
        function collectMonitoringData() {
            const data = [];
            const tbody = document.getElementById('monitoring-tbody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                // Extract actual row ID from the datetime input's id attribute
                const datetimeInput = rows[i].querySelector('input[type="datetime-local"]');
                if (!datetimeInput) continue;
                
                const rowId = datetimeInput.id.split('-')[1]; // Extract ID from "datetime-X"
                const datetime = document.getElementById(`datetime-${rowId}`)?.value;
                if (!datetime) continue;
                
                const entry = {
                    datetime: new Date(datetime),
                    bloodFlow: parseFloat(document.getElementById(`bloodflow-${rowId}`)?.value) || 0,
                    dialysate: parseFloat(document.getElementById(`dialysate-${rowId}`)?.value) || 0,
                    citrate: parseFloat(document.getElementById(`citrate-${rowId}`)?.value) || 0,
                    caInfusion: parseFloat(document.getElementById(`cainfusion-${rowId}`)?.value) || 0,
                    totalCa: parseFloat(document.getElementById(`totalca-${rowId}`)?.value) || 0,
                    iCa: parseFloat(document.getElementById(`ica-${rowId}`)?.value) || 0,
                    pH: parseFloat(document.getElementById(`ph-${rowId}`)?.value) || 0,
                    hco3: parseFloat(document.getElementById(`hco3-${rowId}`)?.value) || 0,
                    urea: parseFloat(document.getElementById(`urea-${rowId}`)?.value) || 0,
                    creatinine: parseFloat(document.getElementById(`creat-${rowId}`)?.value) || 0,
                    sodium: parseFloat(document.getElementById(`na-${rowId}`)?.value) || 0,
                    chloride: parseFloat(document.getElementById(`cl-${rowId}`)?.value) || 0,
                    fluidRemoved: parseFloat(document.getElementById(`removed-${rowId}`)?.value) || 0,
                    fluidBalance: parseFloat(document.getElementById(`balance-${rowId}`)?.value) || 0
                };
                
                data.push(entry);
            }
            
            return data.sort((a, b) => a.datetime - b.datetime);
        }
        
        // Analyse data and generate recommendations
        function analyseData() {
            const data = collectMonitoringData();
            
            if (data.length === 0) {
                alert('Please enter at least one complete row of data with date/time');
                return;
            }
            
            // Show recommendations first, then chart
            document.getElementById('recommendations-container').style.display = 'block';
            document.getElementById('trend-chart-container').style.display = 'block';
            
            // Generate recommendations first
            generateRecommendations(data);
            
            // Then draw trend chart
            drawTrendChart(data);
            
            // Scroll to recommendations
            document.getElementById('recommendations-container').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Draw trend chart with proper multi-axis scaling
        function drawTrendChart(data) {
            const ctx = document.getElementById('trend-chart');
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const labels = data.map(d => d.datetime.toLocaleString('en-GB', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            }));
            
            // Calculate dynamic ranges for better visualization
            const sodiumValues = data.map(d => d.sodium).filter(v => v > 0);
            const iCaValues = data.map(d => d.iCa).filter(v => v > 0);
            const totalCaValues = data.map(d => d.totalCa).filter(v => v > 0);
            const hco3Values = data.map(d => d.hco3).filter(v => v > 0);
            
            // Calculate min/max with padding
            const sodiumMin = Math.max(100, Math.min(...sodiumValues) - 5);
            const sodiumMax = Math.min(200, Math.max(...sodiumValues) + 5);
            
            const caMin = Math.max(0, Math.min(...iCaValues, ...totalCaValues) - 0.2);
            const caMax = Math.min(4, Math.max(...iCaValues, ...totalCaValues) + 0.2);
            
            const hco3Min = Math.max(5, Math.min(...hco3Values) - 3);
            const hco3Max = Math.min(50, Math.max(...hco3Values) + 3);
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sodium (mmol/L)',
                            data: data.map(d => d.sodium || null),
                            borderColor: '#005EB8',
                            backgroundColor: 'rgba(0, 94, 184, 0.1)',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            yAxisID: 'y-sodium',
                            tension: 0.1
                        },
                        {
                            label: 'iCa (mmol/L)',
                            data: data.map(d => d.iCa || null),
                            borderColor: '#007F3B',
                            backgroundColor: 'rgba(0, 127, 59, 0.1)',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            yAxisID: 'y-ca',
                            tension: 0.1
                        },
                        {
                            label: 'Total Ca (mmol/L)',
                            data: data.map(d => d.totalCa || null),
                            borderColor: '#330072',
                            backgroundColor: 'rgba(51, 0, 114, 0.1)',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            yAxisID: 'y-ca',
                            tension: 0.1,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'HCO‚ÇÉ‚Åª (mmol/L)',
                            data: data.map(d => d.hco3 || null),
                            borderColor: '#ED8B00',
                            backgroundColor: 'rgba(237, 139, 0, 0.1)',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            yAxisID: 'y-hco3',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Patient Parameter Trends',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 13
                            },
                            bodyFont: {
                                size: 12
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        'y-sodium': {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Sodium (mmol/L)',
                                color: '#005EB8',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            min: sodiumMin,
                            max: sodiumMax,
                            ticks: {
                                color: '#005EB8',
                                stepSize: 5
                            },
                            grid: {
                                drawOnChartArea: true,
                                color: 'rgba(0, 94, 184, 0.1)'
                            }
                        },
                        'y-ca': {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Calcium (mmol/L)',
                                color: '#007F3B',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            min: caMin,
                            max: caMax,
                            ticks: {
                                color: '#007F3B',
                                stepSize: 0.2
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        'y-hco3': {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Bicarbonate (mmol/L)',
                                color: '#ED8B00',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            min: hco3Min,
                            max: hco3Max,
                            ticks: {
                                color: '#ED8B00',
                                stepSize: 5
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            // Offset this axis to prevent overlap
                            offset: true
                        }
                    }
                }
            });
        }
        
        // Generate clinical recommendations
        function generateRecommendations(data) {
            const latest = data[data.length - 1];
            const recommendations = [];
            
            // Check for filter membrane block - LOWERED THRESHOLDS
            const naIncreasing = data.length > 1 && latest.sodium > data[0].sodium + 3; // Was 5
            const iCaIncreasing = data.length > 1 && latest.iCa > data[0].iCa + 0.05; // Was 0.1
            const hco3Increasing = data.length > 1 && latest.hco3 > data[0].hco3 + 3; // Was 5
            const clearanceWorsening = data.length > 1 && latest.urea > data[0].urea;
            
            // LOWERED THRESHOLDS: Two out of three increasing OR absolute values concerning
            if ((naIncreasing && iCaIncreasing) || (naIncreasing && hco3Increasing) || (iCaIncreasing && hco3Increasing) || 
                (latest.sodium > 145 && latest.pH > 7.48)) { // Was Na >150, pH >7.5
                recommendations.push({
                    priority: 'critical',
                    title: 'üö® FILTER MEMBRANE BLOCK SUSPECTED',
                    text: `Sodium (${latest.sodium}), iCa (${latest.iCa.toFixed(2)}), and bicarbonate (${latest.hco3.toFixed(1)}) are ${naIncreasing ? 'increasing' : 'elevated'}. ${latest.sodium > 145 ? 'Na+ >145. ' : ''}${latest.pH > 7.48 ? 'pH >7.48. ' : ''}${clearanceWorsening ? 'Clearance worsening. ' : ''}<br><br><strong>ACTION: Change filter set immediately.</strong><br><br>Pore blockage prevents dialysis - patient receiving sodium citrate and calcium infusion with minimal clearance. After filter change, may need temporarily higher dialysate flow to clear residual alkalosis.`
                });
            }
            
            // pH management - Metabolic Acidosis
            if (latest.pH < 7.35) {
                if (latest.bloodFlow < 120 && latest.dialysate < 2.5) {
                    recommendations.push({
                        priority: 'critical',
                        title: 'üî¥ Metabolic Acidosis - Switch to Enhanced Protocol',
                        text: `pH: ${latest.pH.toFixed(2)} (target >7.35)<br>Current: Blood ${latest.bloodFlow} mL/min, Dialysate ${latest.dialysate.toFixed(1)} L/h<br><br><strong>STEP 1: Switch to ENHANCED protocol</strong><br>Increase both blood and dialysate flows maintaining 20:1 ratio initially.`
                    });
                } else {
                    recommendations.push({
                        priority: 'warning',
                        title: '‚ö†Ô∏è Metabolic Acidosis - Increase Blood Flow',
                        text: `pH: ${latest.pH.toFixed(2)} (target >7.35)<br>Current: Blood ${latest.bloodFlow} mL/min, Dialysate ${latest.dialysate.toFixed(1)} L/h<br><br><strong>STEP 2: Increase blood flow by 20%</strong><br>New blood flow: ${Math.round(latest.bloodFlow * 1.2)} mL/min<br>Keep dialysate at: ${latest.dialysate.toFixed(1)} L/h<br><em>(Moving off 20:1 ratio is acceptable)</em>`
                    });
                }
                
                if (latest.pH < 7.20) {
                    recommendations.push({
                        priority: 'critical',
                        title: 'üö® SEVERE Metabolic Acidosis',
                        text: `pH: ${latest.pH.toFixed(2)} - SEVERE<br><br>Consider:<br>‚Ä¢ CVVHDF mode for increased clearance<br>‚Ä¢ 8.4% sodium bicarbonate infusion<br>‚Ä¢ Check for citrate accumulation (T:I ratio)<br>‚Ä¢ Senior review immediately`
                    });
                }
            }
            
            // pH management - Metabolic Alkalosis
            if (latest.pH > 7.45 && latest.hco3 > 28) {
                const clearanceAdequate = latest.urea < 10;
                
                if (clearanceAdequate) {
                    recommendations.push({
                        priority: 'warning',
                        title: '‚ö†Ô∏è Metabolic Alkalosis - Reduce Blood Flow',
                        text: `pH: ${latest.pH.toFixed(2)}, HCO‚ÇÉ‚Åª: ${latest.hco3.toFixed(1)} (target pH <7.45, HCO‚ÇÉ‚Åª <28)<br>Urea: ${latest.urea.toFixed(1)} (clearance adequate)<br>Current: Blood ${latest.bloodFlow} mL/min<br><br><strong>STEP 1: Reduce blood flow by 20-30%</strong><br>New blood flow: ${Math.round(latest.bloodFlow * 0.75)} mL/min (minimum 80 mL/min)<br>Keep dialysate at: ${latest.dialysate.toFixed(1)} L/h`
                    });
                } else {
                    recommendations.push({
                        priority: 'warning',
                        title: '‚ö†Ô∏è Metabolic Alkalosis - Reduce Dialysate Flow',
                        text: `pH: ${latest.pH.toFixed(2)}, HCO‚ÇÉ‚Åª: ${latest.hco3.toFixed(1)} (target pH <7.45, HCO‚ÇÉ‚Åª <28)<br>Urea: ${latest.urea.toFixed(1)} (clearance inadequate)<br>Current: Dialysate ${latest.dialysate.toFixed(1)} L/h<br><br><strong>ACTION: Reduce dialysate flow by 20%</strong><br>New dialysate: ${(latest.dialysate * 0.8).toFixed(1)} L/h<br>Keep blood flow at: ${latest.bloodFlow} mL/min`
                    });
                }
            }
            
            // Sodium management
            if (latest.sodium < 125) {
                recommendations.push({
                    priority: 'warning',
                    title: '‚ö†Ô∏è Hyponatraemia - Consider Dialysate Adjustment',
                    text: `Na‚Å∫: ${latest.sodium} mmol/L (severe hyponatraemia)<br><br><strong>Consider adding FREE WATER to dialysate</strong><br>See Sodium Correction tab for precise calculations.<br><br>‚ö†Ô∏è Requires consultant approval and Band 6+ second check<br>‚ö†Ô∏è Maximum correction: 8-10 mmol/L per 24 hours`
                });
            }
            
            if (latest.sodium > 155) {
                recommendations.push({
                    priority: 'warning',
                    title: '‚ö†Ô∏è Hypernatraemia - Consider Dialysate Adjustment',
                    text: `Na‚Å∫: ${latest.sodium} mmol/L (severe hypernatraemia)<br><br><strong>Consider adding 30% NaCl to dialysate</strong><br>See Sodium Correction tab for precise calculations.<br><br>‚ö†Ô∏è Requires consultant approval and Band 6+ second check<br>‚ö†Ô∏è Maximum correction: 8-10 mmol/L per 24 hours`
                });
            }
            
            // Citrate accumulation check
            if (latest.totalCa > 0 && latest.iCa > 0) {
                const ratio = latest.totalCa / latest.iCa;
                if (ratio > 2.25) {
                    recommendations.push({
                        priority: 'critical',
                        title: 'üö® CITRATE ACCUMULATION SUSPECTED',
                        text: `Total:Ionised Ca ratio: ${ratio.toFixed(2)} (normal <2.25)<br>Total Ca: ${latest.totalCa.toFixed(2)}, iCa: ${latest.iCa.toFixed(2)}<br><br><strong>Check for all 4 signs:</strong><br>1. T:I ratio >2.5 ${ratio > 2.5 ? '‚úì' : '‚úó'}<br>2. Total Ca >3.0 ${latest.totalCa > 3.0 ? '‚úì' : '‚úó'}<br>3. Ca infusion >2.0 mmol/L/h ${latest.caInfusion > 2.0 ? '‚úì' : '‚úó'}<br>4. Metabolic acidosis ${latest.pH < 7.35 ? '‚úì' : '‚úó'}<br><br><strong>ACTION: Refer to duty consultant immediately</strong><br>Consider switching anticoagulation mode if all 4 signs present.`
                    });
                }
            }
            
            // Blood flow limits check
            const anticoag = document.getElementById('anticoag').value;
            if (anticoag === 'citrate') {
                if (latest.bloodFlow > 200) {
                    recommendations.push({
                        priority: 'warning',
                        title: '‚ö†Ô∏è Blood Flow Exceeds Citrate Limit',
                        text: `Current blood flow: ${latest.bloodFlow} mL/min<br><br>Maximum for citrate anticoagulation: 200 mL/min<br><br><strong>ACTION: Reduce blood flow to ‚â§200 mL/min</strong>`
                    });
                }
                if (latest.bloodFlow < 80) {
                    recommendations.push({
                        priority: 'info',
                        title: '‚ÑπÔ∏è Low Blood Flow',
                        text: `Current blood flow: ${latest.bloodFlow} mL/min<br><br>Minimum recommended: 80 mL/min<br>Consider using smaller lumen VasCath (11-12F) to prevent disconnection alarms at low flows.`
                    });
                }
            }
            
            // Clearance assessment
            if (latest.urea > 10 && latest.creatinine > 200) {
                recommendations.push({
                    priority: 'warning',
                    title: '‚ö†Ô∏è Inadequate Clearance',
                    text: `Urea: ${latest.urea.toFixed(1)} (target <10), Creat: ${latest.creatinine}<br><br><strong>Progressive actions:</strong><br>1. Use enhanced flow rates<br>2. Recalculate flows using actual body weight<br>3. Check for filter membrane pore block<br>4. Consider CVVHDF for higher clearance`
                });
            }
            
            // If no critical issues
            if (recommendations.length === 0) {
                recommendations.push({
                    priority: 'info',
                    title: '‚úì Parameters Within Acceptable Ranges',
                    text: `Current settings appear appropriate.<br><br>Continue monitoring:<br>‚Ä¢ ABGs every 2-4 hours<br>‚Ä¢ Systemic and circuit iCa¬≤‚Å∫ every 8 hours<br>‚Ä¢ Daily T:I calcium ratio<br>‚Ä¢ Filter life and circuit pressures`
                });
            }
            
            // Display recommendations
            const container = document.getElementById('recommendations-content');
            container.innerHTML = recommendations.map(rec => `
                <div class="recommendation-item ${rec.priority}">
                    <h4 style="margin-bottom: 8px;">${rec.title}</h4>
                    <div style="font-weight: normal;">${rec.text}</div>
                </div>
            `).join('');
        }
        
        // Blood & Dialysate Flow Calculator
        // Flow calculations - update recommendations table
        function updateFlowCalculations() {
            const abw = parseFloat(document.getElementById('abw').value);
            const height = parseFloat(document.getElementById('height').value);
            const sex = document.getElementById('sex').value;
            const anticoag = document.getElementById('anticoag').value;
            
            if (!abw || !height || !sex) {
                document.getElementById('flow-recommendations').innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Enter patient weight, height, and sex at the top of the page to calculate flows</p>';
                document.getElementById('weight-value').textContent = '‚Äî';
                return;
            }
            
            // Calculate IBW
            let ibw;
            if (sex === 'male') {
                const heightInches = height / 2.54;
                ibw = 50 + 2.3 * (heightInches - 60);
            } else {
                const heightInches = height / 2.54;
                ibw = 45.5 + 2.3 * (heightInches - 60);
            }
            ibw = Math.max(ibw, 35);
            
            // Determine which weight to use
            const useIBW = document.getElementById('use-ibw').checked;
            const selectedWeight = useIBW ? ibw : abw;
            document.getElementById('weight-value').textContent = `${selectedWeight.toFixed(1)} kg (${useIBW ? 'IBW' : 'ABW'})`;
            
            // FLOW RATE LIMITS
            const bloodFlowMin = 80; // mL/min minimum for all
            let bloodFlowMax = 200; // Default for citrate
            let dialysateFlowMax = 4000; // mL/h (no restriction for citrate)
            
            if (anticoag === 'heparin') {
                bloodFlowMax = 400; // Up to 400 mL/min for heparin
                dialysateFlowMax = 4000; // No specific limit for heparin
            } else if (anticoag === 'epoprostenol' || anticoag === 'none') {
                bloodFlowMax = 400; // Can go higher without citrate
                dialysateFlowMax = 4000;
            }
            
            // Calculate default flows (25 mL/kg/h clearance)
            const defaultClearance = 25;
            let defaultDialysate = Math.round(selectedWeight * defaultClearance);
            let defaultBlood = Math.round(defaultDialysate / 20);
            
            // Apply limits
            defaultBlood = Math.max(bloodFlowMin, Math.min(defaultBlood, bloodFlowMax));
            defaultDialysate = Math.min(defaultDialysate, dialysateFlowMax);
            
            // Ratio = Dialysate(mL/h) / Blood(mL/min) - units cancel to give ratio
            const defaultRatio = (defaultDialysate / defaultBlood).toFixed(1);
            
            // Calculate enhanced flows (35 mL/kg/h clearance)
            const enhancedClearance = 35;
            let enhancedDialysate = Math.round(selectedWeight * enhancedClearance);
            let enhancedBlood = Math.round(enhancedDialysate / 20);
            
            // Apply limits
            enhancedBlood = Math.max(bloodFlowMin, Math.min(enhancedBlood, bloodFlowMax));
            enhancedDialysate = Math.min(enhancedDialysate, dialysateFlowMax);
            
            const enhancedRatio = (enhancedDialysate / enhancedBlood).toFixed(1);
            
            // Create warnings if limits were hit
            let limitWarnings = '';
            if (anticoag === 'citrate') {
                if (defaultBlood >= bloodFlowMax || enhancedBlood >= bloodFlowMax) {
                    limitWarnings += '<div style="background: #FFF4E5; border-left: 4px solid #ED8B00; padding: 12px; margin-top: 10px; font-size: 13px;"><strong>‚ö†Ô∏è Citrate Limit:</strong> Blood flow capped at 200 mL/min for citrate anticoagulation</div>';
                }
            }
            
            document.getElementById('flow-recommendations').innerHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: var(--light-bg);">
                            <th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--nhs-blue);">Parameter</th>
                            <th style="text-align: center; padding: 10px; border-bottom: 2px solid var(--nhs-blue);">Default</th>
                            <th style="text-align: center; padding: 10px; border-bottom: 2px solid var(--nhs-blue);">Enhanced</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>Blood Flow (mL/min)</strong></td>
                            <td style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">${defaultBlood}</td>
                            <td style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">${enhancedBlood}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>Dialysate Flow (mL/h)</strong></td>
                            <td style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">${defaultDialysate}</td>
                            <td style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">${enhancedDialysate}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>Clearance (mL/kg/h)</strong></td>
                            <td style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">${(defaultDialysate/selectedWeight).toFixed(1)}</td>
                            <td style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">${(enhancedDialysate/selectedWeight).toFixed(1)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>Ratio (Dialysate:Blood)</strong></td>
                            <td style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">${defaultRatio}:1</td>
                            <td style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">${enhancedRatio}:1</td>
                        </tr>
                        <tr style="background: rgba(0,94,184,0.05);">
                            <td style="padding: 10px; font-weight: 600;">Indications</td>
                            <td style="text-align: center; padding: 10px; font-size: 12px;">Standard RRT<br>Stable patients</td>
                            <td style="text-align: center; padding: 10px; font-size: 12px;">Severe acidosis (pH <7.2)<br>Hyperkalaemia (K+ ‚â•6.5)<br>Inadequate clearance</td>
                        </tr>
                    </tbody>
                </table>
                ${limitWarnings}
            `;
        }
        
        // Custom flow calculator
        function calculateCustomFlows() {
            const bloodFlow = parseFloat(document.getElementById('custom-blood-flow').value);
            const dialysateFlow = parseFloat(document.getElementById('custom-dialysate-flow').value);
            const abw = parseFloat(document.getElementById('abw').value);
            const height = parseFloat(document.getElementById('height').value);
            const sex = document.getElementById('sex').value;
            
            if (!bloodFlow || !dialysateFlow) {
                document.getElementById('custom-flow-results').innerHTML = '';
                document.getElementById('custom-flow-notes').innerHTML = '';
                return;
            }
            
            // Calculate IBW and get both weights
            let ibw, clearanceIBW, clearanceABW;
            if (abw && height && sex) {
                const heightInches = height / 2.54;
                if (sex === 'male') {
                    ibw = 50 + 2.3 * (heightInches - 60);
                } else {
                    ibw = 45.5 + 2.3 * (heightInches - 60);
                }
                ibw = Math.max(ibw, 35);
                
                // Calculate clearance for both
                clearanceIBW = dialysateFlow / ibw;
                clearanceABW = dialysateFlow / abw;
            } else {
                document.getElementById('custom-flow-results').innerHTML = '<p style="color: #DA291C;">Enter patient data at top of page</p>';
                return;
            }
            
            // Get filter type and anticoagulation
            const filterType = document.getElementById('filter-type').value;
            const anticoag = document.getElementById('anticoag').value;
            
            // Ratio = Dialysate(mL/h) / Blood(mL/min)
            const ratio = dialysateFlow / bloodFlow;
            
            // Display results
            document.getElementById('custom-flow-results').innerHTML = `
                <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ccc;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                        <div><strong>Clearance (IBW):</strong></div>
                        <div style="text-align: right;">${clearanceIBW.toFixed(1)} mL/kg/h</div>
                        <div><strong>Clearance (ABW):</strong></div>
                        <div style="text-align: right;">${clearanceABW.toFixed(1)} mL/kg/h</div>
                        <div><strong>Ratio:</strong></div>
                        <div style="text-align: right;">${ratio.toFixed(1)}:1</div>
                    </div>
                </div>
            `;
            
            // Generate notes about benefits/risks
            let notes = '<div style="background: rgba(0,94,184,0.05); padding: 12px; border-radius: 4px; border-left: 3px solid var(--nhs-blue);"><strong>Notes:</strong><ul style="margin: 8px 0 0 20px; font-size: 12px;">';
            
            // Clearance assessment
            if (clearance < 20) {
                notes += '<li><strong style="color: #DA291C;">‚ö† Low clearance</strong> - May be insufficient for adequate solute removal. Consider increasing flows.</li>';
            } else if (clearance >= 20 && clearance < 30) {
                notes += '<li><strong style="color: #007F3B;">‚úì Standard clearance</strong> - Appropriate for most patients.</li>';
            } else if (clearance >= 30 && clearance < 40) {
                notes += '<li><strong style="color: #005EB8;">Enhanced clearance</strong> - Good for severe acidosis, hyperkalaemia, or high catabolic states.</li>';
            } else {
                notes += '<li><strong style="color: #ED8B00;">‚ö† Very high clearance</strong> - May increase risk of hypothermia and electrolyte depletion. Ensure close monitoring.</li>';
            }
            
            // Ratio assessment
            if (ratio < 15) {
                notes += '<li><strong style="color: #ED8B00;">Low ratio</strong> - May reduce filter life. Consider increasing dialysate flow.</li>';
            } else if (ratio > 25) {
                notes += '<li><strong style="color: #ED8B00;">High ratio</strong> - Economical but may reduce clearance efficiency.</li>';
            } else {
                notes += '<li><strong style="color: #007F3B;">‚úì Optimal ratio (15-25:1)</strong> - Good balance between efficiency and filter life.</li>';
            }
            
            // Blood flow assessment
            if (bloodFlow < 80) {
                notes += '<li><strong style="color: #ED8B00;">Low blood flow</strong> - Increased clotting risk. Ensure adequate anticoagulation.</li>';
            } else if (bloodFlow > 150) {
                notes += '<li><strong style="color: #005EB8;">High blood flow</strong> - Good for enhanced clearance but may stress vascular access.</li>';
            }
            
            // Filter-specific notes
            if (filterType === 'av1000s') {
                notes += '<li><strong>AV1000s filter:</strong> Smaller membrane area (20kDa). Best for blood flows 80-120 mL/min.</li>';
            } else if (filterType === 'emic2') {
                notes += '<li><strong>EMIC2 filter:</strong> Larger membrane area (40kDa). Can handle higher blood flows up to 150-180 mL/min.</li>';
            }
            
            // Anticoagulation notes
            if (anticoag === 'citrate') {
                notes += '<li><strong>Citrate anticoagulation:</strong> Monitor Ca ratio closely. Higher flows may require citrate dose adjustment.</li>';
            } else if (anticoag === 'none') {
                notes += '<li><strong style="color: #DA291C;">No anticoagulation:</strong> Blood flow >100 mL/min recommended to reduce clotting risk. Consider frequent filter assessments.</li>';
            }
            
            notes += '</ul></div>';
            document.getElementById('custom-flow-notes').innerHTML = notes;
        }
        
        // Calcium Dose Calculator
        function calculateCalcium() {
            const ica = parseFloat(document.getElementById('ica-systemic').value);
            const resultDiv = document.getElementById('calcium-result');
            
            if (!ica || ica < 0.5 || ica > 2.0) {
                resultDiv.innerHTML = 'Please enter a valid iCa¬≤‚Å∫ between 0.5-2.0 mmol/L';
                resultDiv.className = 'result warning';
                return;
            }
            
            let action, nextCheck, dose, alertLevel, emergencyProtocol = '';
            
            if (ica < 0.80) {
                action = '<strong style="color: #DA291C;">CRITICAL HYPOCALCAEMIA</strong>';
                nextCheck = 'Recheck in 1 HOUR after bolus';
                dose = 'Increase calcium infusion by 0.4 mmol/L';
                alertLevel = 'danger';
                emergencyProtocol = `
                    <div style="background: #FFE5E5; padding: 12px; border-radius: 4px; border-left: 4px solid #DA291C; margin-top: 10px;">
                        <strong>üö® IMMEDIATE ACTION REQUIRED:</strong><br>
                        1. <strong>INFORM CLINICIAN IMMEDIATELY</strong><br>
                        2. Give 10mL 10% CaCl‚ÇÇ (10mmol) IV bolus<br>
                        3. Increase calcium infusion by 0.4 mmol/L<br>
                        4. Recheck iCa¬≤‚Å∫ in 1 hour
                    </div>
                `;
            } else if (ica >= 0.80 && ica < 1.00) {
                action = 'INCREASE calcium infusion by 0.4 mmol/L';
                nextCheck = 'Recheck in 2 HOURS (not 8 hours)';
                dose = 'Increase by 0.4 mmol/L';
                alertLevel = 'danger';
                emergencyProtocol = '<div style="background: #FFF4E5; padding: 10px; border-radius: 4px; border-left: 3px solid #ED8B00; margin-top: 10px;"><strong>‚ö†Ô∏è INFORM CLINICIAN</strong> - Significantly low calcium</div>';
            } else if (ica >= 1.00 && ica < 1.12) {
                action = 'INCREASE calcium infusion by 0.2 mmol/L';
                nextCheck = 'Recheck in 8 hours';
                dose = 'Increase by 0.2 mmol/L';
                alertLevel = 'warning';
            } else if (ica >= 1.12 && ica <= 1.20) {
                action = 'NO CHANGE - within target range (1.12-1.20 mmol/L)';
                nextCheck = 'Recheck in 8 hours';
                dose = 'Maintain current infusion rate';
                alertLevel = 'success';
            } else if (ica > 1.20 && ica <= 1.35) {
                action = 'DECREASE calcium infusion by 0.2 mmol/L';
                nextCheck = 'Recheck in 8 hours';
                dose = 'Decrease by 0.2 mmol/L';
                alertLevel = 'warning';
            } else {
                action = '<strong style="color: #DA291C;">DECREASE calcium infusion by 0.4 mmol/L</strong>';
                nextCheck = 'Recheck in 4 hours';
                dose = 'Decrease by 0.4 mmol/L';
                alertLevel = 'danger';
                emergencyProtocol = '<div style="background: #FFE5E5; padding: 10px; border-radius: 4px; border-left: 3px solid #DA291C; margin-top: 10px;"><strong>‚ö†Ô∏è INFORM CLINICIAN</strong> - Hypercalcaemia (>1.35 mmol/L)</div>';
            }
            
            const resultText = `
                <strong>Systemic iCa¬≤‚Å∫: ${ica.toFixed(2)} mmol/L</strong><br>
                <strong>Target Range:</strong> 1.12-1.20 mmol/L<br><br>
                <strong>Action:</strong> ${action}<br>
                <strong>Dose Adjustment:</strong> ${dose}<br>
                <strong>Next Check:</strong> ${nextCheck}
                ${emergencyProtocol}
            `;
            
            resultDiv.innerHTML = resultText;
            resultDiv.className = 'result ' + alertLevel;
        }
        
        // Citrate Dose Calculator
        function calculateCitrate() {
            const ica = parseFloat(document.getElementById('ica-circuit').value);
            const resultDiv = document.getElementById('citrate-result');
            
            if (!ica || ica < 0.1 || ica > 1.0) {
                resultDiv.innerHTML = 'Please enter a valid circuit iCa¬≤‚Å∫ between 0.1-1.0 mmol/L';
                resultDiv.className = 'result warning';
                return;
            }
            
            let action, alertLevel, informClinician = false;
            
            if (ica < 0.20) {
                action = '<strong style="color: #DA291C;">DECREASE citrate dose by 0.2 mmol/L</strong><br>‚ö†Ô∏è <strong>INFORM CLINICIAN IMMEDIATELY</strong>';
                alertLevel = 'danger';
                informClinician = true;
            } else if (ica >= 0.20 && ica < 0.25) {
                action = 'DECREASE citrate dose by 0.1 mmol/L';
                alertLevel = 'warning';
            } else if (ica >= 0.25 && ica <= 0.34) {
                action = 'NO CHANGE - within target range (0.25-0.34 mmol/L). Maintain current citrate dose.';
                alertLevel = 'success';
            } else if (ica > 0.34 && ica <= 0.40) {
                action = 'INCREASE citrate dose by 0.1 mmol/L';
                alertLevel = 'warning';
            } else {
                action = '<strong style="color: #DA291C;">INCREASE citrate dose by 0.2 mmol/L</strong><br>‚ö†Ô∏è <strong>INFORM CLINICIAN IMMEDIATELY</strong>';
                alertLevel = 'danger';
                informClinician = true;
            }
            
            const resultText = `
                <strong>Circuit (Post-filter) iCa¬≤‚Å∫: ${ica.toFixed(2)} mmol/L</strong><br>
                <strong>Target Range:</strong> 0.25-0.34 mmol/L<br><br>
                <strong>Action:</strong> ${action}<br>
                <strong>Next Check:</strong> 8 hours after adjustment<br>
                <strong>Sampling Point:</strong> Blue port on circuit
                ${informClinician ? '<br><br><div style="background: #FFE5E5; padding: 10px; border-radius: 4px; border-left: 3px solid #DA291C; margin-top: 10px;"><strong>‚ö†Ô∏è ALERT:</strong> Significant deviation from target range. Inform clinician and review RRT parameters.</div>' : ''}
            `;
            
            resultDiv.innerHTML = resultText;
            resultDiv.className = 'result ' + alertLevel;
        }
        
        // Sodium Correction Calculator V3.0 - Correction-Rate-First Approach
        // Auto-recalculate sodium correction if results are already visible
        function autoRecalculateSodium() {
            const resultsDiv = document.getElementById('sodium-results');
            // Only auto-recalculate if results are currently visible
            if (resultsDiv && resultsDiv.style.display === 'block' && resultsDiv.innerHTML.trim() !== '') {
                calculateSodiumCorrectionV3();
            }
        }
        
        function calculateSodiumCorrectionV3() {
            // Get patient parameters from top of page
            const patientWeight = parseFloat(document.getElementById('abw').value);
            const patientHeight = parseFloat(document.getElementById('height').value);
            const patientSex = document.getElementById('sex').value;
            
            // Get sodium-specific parameters
            const patientNa = parseFloat(document.getElementById('na-patient-na').value);
            const correctionRateRange = document.getElementById('na-correction-rate').value;
            const dialysateName = document.getElementById('na-dialysate').value;
            const additiveName = document.getElementById('na-additive').value;
            const bloodFlow = parseFloat(document.getElementById('na-blood-flow').value);
            const dialysateFlow = parseFloat(document.getElementById('na-dialysate-flow').value);
            
            const resultsDiv = document.getElementById('sodium-results');
            
            // Validation
            if (!patientWeight || !patientHeight || !patientSex) {
                resultsDiv.innerHTML = '<div class="alert" style="background: #FFF4E5;"><strong>Incomplete Patient Data:</strong> Please enter weight, height, and sex at the top of the page.</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            if (!patientNa || patientNa < 100 || patientNa > 200) {
                resultsDiv.innerHTML = '<div class="alert" style="background: #FFF4E5;"><strong>Invalid Input:</strong> Please enter a valid patient sodium between 100-200 mmol/L</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            if (!correctionRateRange) {
                resultsDiv.innerHTML = '<div class="alert" style="background: #FFF4E5;"><strong>Missing Input:</strong> Please select target rate of sodium correction</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            if (!dialysateName || !additiveName) {
                resultsDiv.innerHTML = '<div class="alert" style="background: #FFF4E5;"><strong>Missing Input:</strong> Please select base dialysate and additive fluid</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            // Check if standard bags should be used
            if (patientNa >= 125 && patientNa <= 155) {
                resultsDiv.innerHTML = `
                    <div class="tool-card" style="border-left: 5px solid var(--nhs-green);">
                        <h2 style="color: var(--nhs-green);">‚úì Use Standard Dialysate Bags</h2>
                        <p><strong>Patient Na+:</strong> ${patientNa} mmol/L</p>
                        <p style="margin-top: 15px;">Patient sodium is within acceptable range (125-155 mmol/L).</p>
                        <p><strong>Recommendation:</strong> Use standard ${dialysateName} without modification.</p>
                        <p style="margin-top: 10px; font-size: 13px; color: #666;">Monitor sodium every 4-6 hours and adjust RRT flow rate as needed to control correction rate.</p>
                    </div>
                `;
                resultsDiv.style.display = 'block';
                return;
            }
            
            // Calculate blood volume and TBW
            const heightMetres = patientHeight / 100;
            let bloodVolume;
            if (patientSex === 'male') {
                bloodVolume = (0.3669 * Math.pow(heightMetres, 3)) + (0.03219 * patientWeight) + 0.6041;
            } else {
                bloodVolume = (0.3561 * Math.pow(heightMetres, 3)) + (0.03308 * patientWeight) + 0.1833;
            }
            
            const tbw = patientSex === 'male' ? 0.6 * patientWeight : 0.5 * patientWeight;
            
            // Parse target correction rate (use midpoint)
            let targetCorrectionRate;
            if (correctionRateRange === '4-6') targetCorrectionRate = 5;
            else if (correctionRateRange === '6-8') targetCorrectionRate = 7;
            else if (correctionRateRange === '8-10') targetCorrectionRate = 9;
            else if (correctionRateRange === '10-12') targetCorrectionRate = 11;
            
            // Dialysate compositions (including Mg and Glucose)
            const dialysates = {
                'Ci-Ca K4': { Na: 133, Cl: 118.5, K: 4, HCO3: 20, Mg: 0.5, Glucose: 5.6 },
                'Ci-Ca K2': { Na: 133, Cl: 116.5, K: 2, HCO3: 20, Mg: 0.5, Glucose: 5.6 },
                'multiBic 2K': { Na: 140, Cl: 111, K: 2, HCO3: 35, Mg: 0.75, Glucose: 5.6 },
                'multiBic 4K': { Na: 140, Cl: 113, K: 4, HCO3: 35, Mg: 0.75, Glucose: 5.6 }
            };
            
            const dialysate = dialysates[dialysateName];
            const baseNa = dialysate.Na;
            const bagVolume = 5000;
            
            // Calculate required gradient and target dialysate Na
            const effectiveClearance = dialysateFlow * 0.8 / 1000; // L/h
            const requiredGradient = (targetCorrectionRate * tbw) / (effectiveClearance * 24);
            
            let targetNa, correctionType;
            if (patientNa > 155) {
                correctionType = 'hypernatraemia';
                targetNa = patientNa - requiredGradient;
            } else {
                correctionType = 'hyponatraemia';
                targetNa = patientNa + requiredGradient;
            }
            
            // Validate additive selection
            const needToRaise = targetNa > baseNa;
            const needToLower = targetNa < baseNa;
            
            if (needToRaise && additiveName === 'sterile-water') {
                resultsDiv.innerHTML = `
                    <div class="alert" style="background: #FFF4E5;">
                        <strong>Invalid Additive Selection</strong><br>
                        Need to RAISE dialysate sodium from ${baseNa} to ${targetNa.toFixed(1)} mmol/L.<br>
                        Cannot use sterile water. Please select a <strong>NaCl additive</strong>.
                    </div>
                `;
                resultsDiv.style.display = 'block';
                return;
            }
            
            if (needToLower && additiveName !== 'sterile-water') {
                resultsDiv.innerHTML = `
                    <div class="alert" style="background: #FFF4E5;">
                        <strong>Invalid Additive Selection</strong><br>
                        Need to LOWER dialysate sodium from ${baseNa} to ${targetNa.toFixed(1)} mmol/L.<br>
                        Cannot use NaCl. Please select <strong>Sterile Water</strong>.
                    </div>
                `;
                resultsDiv.style.display = 'block';
                return;
            }
            
            // Calculate volumes using remove-and-replace method
            let result = {};
            
            if (additiveName === 'sterile-water') {
                // Hyponatraemia - dilution with water
                const volumeToRemove = (bagVolume * (baseNa - targetNa)) / baseNa;
                result = {
                    volumeToRemove: volumeToRemove,
                    volumeToAdd: volumeToRemove,
                    finalNa: (baseNa * (bagVolume - volumeToRemove)) / bagVolume,
                    additive: 'Sterile Water',
                    additiveConcentration: 0
                };
            } else {
                // Hypernatraemia - concentration with NaCl
                const naclConcentrations = {
                    '0.9%': 154,
                    '1.26%': 215.5,
                    '1.4%': 239.6,
                    '5%': 855,
                    '30%': 5134
                };
                const additiveConc = naclConcentrations[additiveName];
                const volumeToRemove = (bagVolume * (targetNa - baseNa)) / (additiveConc - baseNa);
                result = {
                    volumeToRemove: volumeToRemove,
                    volumeToAdd: volumeToRemove,
                    finalNa: ((baseNa * (bagVolume - volumeToRemove)) + (additiveConc * volumeToRemove)) / bagVolume,
                    additive: additiveName + ' NaCl',
                    additiveConcentration: additiveConc
                };
            }
            
            // CHECK FOR IMPRACTICAL VOLUMES
            if (result.volumeToRemove > 4500) {
                resultsDiv.innerHTML = `
                    <div class="alert" style="background: #FFE5E5; border-left: 5px solid var(--nhs-red);">
                        <strong>‚ö†Ô∏è Impractical Volume Required</strong><br><br>
                        <p>Would need to remove <strong>${result.volumeToRemove.toFixed(0)} mL</strong> from a 5000 mL dialysate bag.</p>
                        <p style="margin-top: 10px;">This additive <strong>(${result.additive})</strong> is too weak/dilute for this degree of correction.</p>
                        <p style="margin-top: 10px; font-size: 15px;"><strong>SOLUTION:</strong> Use a more concentrated additive:</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li><strong>For hypernatraemia:</strong> Try 5% or 30% NaCl instead of ${additiveName}</li>
                            <li><strong>For hyponatraemia:</strong> Consider adjusting target correction rate to require less dilution</li>
                        </ul>
                        <p style="margin-top: 15px; font-size: 13px; color: #666;">The volume required exceeds 90% of the bag volume, making this prescription impractical to prepare safely.</p>
                    </div>
                `;
                resultsDiv.style.display = 'block';
                return;
            }
            
            if (result.volumeToRemove > 1000) {
                // Show warning but allow to continue
                const warningHtml = `
                    <div class="alert" style="background: #FFF4E5; border-left: 5px solid var(--nhs-orange); margin-bottom: 20px;">
                        <strong>‚ö†Ô∏è Large Volume Warning</strong><br>
                        This prescription requires removing/adding <strong>${result.volumeToRemove.toFixed(0)} mL</strong>.<br>
                        Consider using a more concentrated additive for easier preparation.
                    </div>
                `;
                // This will be prepended to results
                result.volumeWarning = warningHtml;
            }
            
            // Calculate actual correction rate
            const actualGradient = Math.abs(patientNa - result.finalNa);
            const actualCorrectionRate = (effectiveClearance * actualGradient * 24) / tbw;
            
            let safetyColor, safetyAssessment;
            if (actualCorrectionRate <= 10) {
                safetyColor = 'var(--nhs-green)';
                safetyAssessment = '‚úì Safe correction rate';
            } else if (actualCorrectionRate <= 12) {
                safetyColor = 'var(--nhs-orange)';
                safetyAssessment = '‚ö† Borderline - monitor closely';
            } else {
                safetyColor = 'var(--nhs-red)';
                safetyAssessment = '‚ö† Too rapid - consider reducing';
            }
            
            // Generate 3-column results HTML
            const correctionTypeText = correctionType === 'hypernatraemia' ? 'HYPERNATRAEMIA' : 'HYPONATRAEMIA';
            
            resultsDiv.innerHTML = `
                ${result.volumeWarning || ''}
                <div style="display: grid; grid-template-columns: 0.9fr 1.2fr 0.9fr; gap: 15px;">
                    <!-- COLUMN 1: PRESCRIPTION -->
                    <div class="tool-card" style="margin: 0; border-left: 5px solid var(--nhs-red);">
                        <h3 style="color: var(--nhs-red);">üìã PRESCRIPTION</h3>
                        <p style="font-size: 15px; margin: 10px 0;"><strong>STEP 1:</strong> Remove ${result.volumeToRemove.toFixed(0)} mL from 5L ${dialysateName} bag</p>
                        <p style="font-size: 15px; margin: 10px 0;"><strong>STEP 2:</strong> Add ${result.volumeToAdd.toFixed(0)} mL of ${result.additive} back</p>
                        <p style="font-size: 13px; color: #666; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 15px;">
                            Final bag volume: 5000 mL<br>
                            Final Na+: ${result.finalNa.toFixed(1)} mmol/L
                        </p>
                        
                        <div style="margin-top: 15px; padding: 12px; background: ${safetyColor.replace('var(--nhs-', 'rgba(').replace(')', ', 0.1)')}; border-radius: 4px; border-left: 3px solid ${safetyColor};">
                            <strong>Estimated Correction Rate</strong><br>
                            Target: ${correctionRateRange} mmol/L/24h<br>
                            Predicted: ${actualCorrectionRate.toFixed(1)} mmol/L/24h<br>
                            <strong style="color: ${safetyColor};">${safetyAssessment}</strong>
                        </div>
                    </div>
                    
                    <!-- COLUMN 2: SENSECHECK -->
                    <div class="tool-card" style="margin: 0; border-left: 5px solid var(--nhs-green); background: #F0FFF4;">
                        <h3 style="color: var(--nhs-green);">‚úì SENSECHECK</h3>
                        <table style="width: 100%; font-size: 12px; margin: 10px 0;">
                            <tr style="border-bottom: 1px solid #ddd;">
                                <th style="text-align: left; padding: 5px;">Component</th>
                                <th style="text-align: right; padding: 5px;">Volume<br>(mL)</th>
                                <th style="text-align: right; padding: 5px;">Total Na+<br>(g | mmol)</th>
                                <th style="text-align: right; padding: 5px;">Concentration<br>(mmol/L)</th>
                            </tr>
                            <tr>
                                <td style="padding: 5px;"><strong>Dialysate</strong><br><small>${dialysateName}</small></td>
                                <td style="text-align: right; padding: 5px;">${(bagVolume - result.volumeToRemove).toFixed(0)}</td>
                                <td style="text-align: right; padding: 5px;">${((baseNa * (bagVolume - result.volumeToRemove)) / 1000 * 23).toFixed(2)} <span style="color: #999;">|</span> ${(baseNa * (bagVolume - result.volumeToRemove)).toFixed(0)}</td>
                                <td style="text-align: right; padding: 5px;">${baseNa}</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px;"><strong>Additive</strong><br><small>${result.additive}</small></td>
                                <td style="text-align: right; padding: 5px;">${result.volumeToAdd.toFixed(0)}</td>
                                <td style="text-align: right; padding: 5px;">${additiveName === 'sterile-water' ? '0.00 <span style="color: #999;">|</span> 0' : ((result.additiveConcentration * result.volumeToAdd) / 1000 * 23).toFixed(2) + ' <span style="color: #999;">|</span> ' + (result.additiveConcentration * result.volumeToAdd).toFixed(0)}</td>
                                <td style="text-align: right; padding: 5px;">${additiveName === 'sterile-water' ? '0' : result.additiveConcentration.toFixed(1)}</td>
                            </tr>
                            <tr style="background: #ffffcc; font-weight: bold; border-top: 2px solid var(--nhs-blue);">
                                <td style="padding: 5px;">TOTAL</td>
                                <td style="text-align: right; padding: 5px;">5000</td>
                                <td style="text-align: right; padding: 5px;">${additiveName === 'sterile-water' ? ((baseNa * (bagVolume - result.volumeToRemove)) / 1000 * 23).toFixed(2) + ' <span style="color: #999;">|</span> ' + (baseNa * (bagVolume - result.volumeToRemove)).toFixed(0) : (((baseNa * (bagVolume - result.volumeToRemove)) + (result.additiveConcentration * result.volumeToAdd)) / 1000 * 23).toFixed(2) + ' <span style="color: #999;">|</span> ' + ((baseNa * (bagVolume - result.volumeToRemove)) + (result.additiveConcentration * result.volumeToAdd)).toFixed(0)}</td>
                                <td style="text-align: right; padding: 5px; font-size: 14px;">${result.finalNa.toFixed(1)}</td>
                            </tr>
                        </table>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            ‚úì Target: ${targetNa.toFixed(1)} mmol/L<br>
                            ‚úì Achieved: ${result.finalNa.toFixed(1)} mmol/L<br>
                            ‚úì Volume: 5000 mL
                        </p>
                    </div>
                    
                    <!-- COLUMN 3: PROTOCOL -->
                    <div class="tool-card" style="margin: 0; border-left: 5px solid var(--nhs-blue);">
                        <h3 style="color: var(--nhs-blue);">${correctionTypeText} PROTOCOL</h3>
                        <p style="font-size: 13px; margin: 5px 0;">
                            <strong>Patient Na+:</strong> ${patientNa} mmol/L<br>
                            <strong>Target Rate:</strong> ${correctionRateRange} mmol/L/24h<br>
                            <strong>Base Dialysate:</strong> ${dialysateName} (${baseNa} mmol/L)<br>
                            <strong>Target Dialysate:</strong> ${targetNa.toFixed(1)} mmol/L<br>
                            <strong>Gradient:</strong> ${actualGradient.toFixed(1)} mmol/L
                        </p>
                        <div style="background: rgba(0,94,184,0.1); padding: 8px; border-radius: 4px; margin: 10px 0; font-size: 12px;">
                            <strong>Patient:</strong><br>
                            ${patientSex === 'male' ? 'Male' : 'Female'}, ${patientWeight} kg, ${patientHeight} cm<br>
                            TBW: ${tbw.toFixed(1)} L<br>
                            Blood vol: ${bloodVolume.toFixed(2)} L
                        </div>
                        <div style="background: rgba(0,94,184,0.1); padding: 8px; border-radius: 4px; font-size: 12px;">
                            <strong>RRT:</strong><br>
                            Blood: ${bloodFlow} mL/min<br>
                            Dialysate: ${dialysateFlow} mL/h<br>
                            Clearance: ${effectiveClearance.toFixed(2)} L/h
                        </div>
                    </div>
                </div>
                
                <!-- ALTERNATIVE ADDITIVE OPTIONS TABLE -->
                <div class="tool-card" style="margin-top: 15px;">
                    <h3>Alternative Additive Options</h3>
                    <p style="font-size: 13px; color: #666; margin-bottom: 10px;">To achieve the same target Na+ of ${targetNa.toFixed(1)} mmol/L, you could use:</p>
                    <table style="width: 100%; font-size: 13px;">
                        <thead>
                            <tr style="background: var(--light-bg);">
                                <th style="text-align: left; padding: 8px;">Additive</th>
                                <th style="text-align: right; padding: 8px;">Concentration (mmol/L)</th>
                                <th style="text-align: right; padding: 8px;">Volume Remove/Add (mL)</th>
                                <th style="text-align: center; padding: 8px;">Practicality</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${correctionType === 'hypernatraemia' ? `
                                ${(() => {
                                    const alternatives = [
                                        { name: '0.9% NaCl', conc: 154 },
                                        { name: '1.26% NaCl', conc: 215.5 },
                                        { name: '1.4% NaCl', conc: 239.6 },
                                        { name: '5% NaCl', conc: 855 },
                                        { name: '30% NaCl', conc: 5134 }
                                    ];
                                    
                                    return alternatives.map(alt => {
                                        const vol = (bagVolume * (targetNa - baseNa)) / (alt.conc - baseNa);
                                        let practicality, rowStyle;
                                        
                                        if (vol > 4500) {
                                            practicality = '‚úó Impractical';
                                            rowStyle = 'color: #D5281B;';
                                        } else if (vol > 1000) {
                                            practicality = '‚ö† Large volume';
                                            rowStyle = 'color: #ED8B00;';
                                        } else if (vol > 500) {
                                            practicality = '‚ö† Acceptable';
                                            rowStyle = 'color: #ED8B00;';
                                        } else if (vol > 200) {
                                            practicality = '‚úì Good';
                                            rowStyle = 'color: #007F3B;';
                                        } else {
                                            practicality = '‚úì Excellent';
                                            rowStyle = 'color: #007F3B; font-weight: bold;';
                                        }
                                        
                                        const isSelected = alt.name === additiveName + ' NaCl';
                                        const selectedStyle = isSelected ? 'background: #ffffcc; font-weight: bold;' : '';
                                        
                                        return `
                                            <tr style="${selectedStyle}">
                                                <td style="padding: 8px;">${alt.name}${isSelected ? ' <strong>(SELECTED)</strong>' : ''}</td>
                                                <td style="text-align: right; padding: 8px;">${alt.conc.toFixed(1)}</td>
                                                <td style="text-align: right; padding: 8px;">${vol.toFixed(0)}</td>
                                                <td style="text-align: center; padding: 8px; ${rowStyle}">${practicality}</td>
                                            </tr>
                                        `;
                                    }).join('');
                                })()}
                            ` : `
                                <tr>
                                    <td colspan="4" style="padding: 8px; text-align: center; color: #666;">
                                        <em>For hyponatraemia correction, only sterile water is appropriate for dilution.</em>
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
                
                <!-- FINAL DIALYSATE COMPOSITION TABLE -->
                <div class="tool-card" style="margin-top: 15px;">
                    <h3>Final Dialysate Composition</h3>
                    <table style="width: 100%; font-size: 13px;">
                        <thead>
                            <tr style="background: var(--light-bg);">
                                <th style="text-align: left; padding: 8px;">Parameter</th>
                                <th style="text-align: right; padding: 8px;">Starting</th>
                                <th style="text-align: right; padding: 8px;">Final</th>
                                <th style="text-align: right; padding: 8px;">Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(() => {
                                // For sterile water: dilutes everything
                                // For NaCl: dilutes K+ and HCO3- (no K or HCO3 in NaCl)
                                const dilutionFactor = (bagVolume - result.volumeToRemove) / bagVolume;
                                
                                // K+ and HCO3- always diluted (neither in sterile water nor NaCl)
                                const finalK = dialysate.K * dilutionFactor;
                                const finalHCO3 = dialysate.HCO3 * dilutionFactor;
                                
                                // Cl- calculation:
                                // - For water: dilutes
                                // - For NaCl: base Cl diluted + additive Cl added
                                const finalCl = additiveName === 'sterile-water' ? 
                                    dialysate.Cl * dilutionFactor :
                                    ((dialysate.Cl * (bagVolume - result.volumeToRemove)) + (result.additiveConcentration * result.volumeToAdd)) / bagVolume;
                                
                                const baseOsmolality = 2 * baseNa;
                                const finalOsmolality = 2 * result.finalNa;
                                
                                return `
                                    <tr>
                                        <td style="padding: 8px;"><strong>Sodium (Na+)</strong></td>
                                        <td style="text-align: right; padding: 8px;">${baseNa.toFixed(1)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px; font-weight: bold; color: var(--nhs-blue);">${result.finalNa.toFixed(1)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px;">${(result.finalNa - baseNa) > 0 ? '+' : ''}${(result.finalNa - baseNa).toFixed(1)}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px;"><strong>Potassium (K+)</strong></td>
                                        <td style="text-align: right; padding: 8px;">${dialysate.K.toFixed(1)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px;">${finalK.toFixed(1)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px;">${(finalK - dialysate.K) > 0 ? '+' : ''}${(finalK - dialysate.K).toFixed(1)}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px;"><strong>Chloride (Cl-)</strong></td>
                                        <td style="text-align: right; padding: 8px;">${dialysate.Cl.toFixed(1)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px;">${finalCl.toFixed(1)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px;">${(finalCl - dialysate.Cl) > 0 ? '+' : ''}${(finalCl - dialysate.Cl).toFixed(1)}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px;"><strong>Bicarbonate (HCO3-)</strong></td>
                                        <td style="text-align: right; padding: 8px;">${dialysate.HCO3.toFixed(1)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px;">${finalHCO3.toFixed(1)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px;">${(finalHCO3 - dialysate.HCO3) > 0 ? '+' : ''}${(finalHCO3 - dialysate.HCO3).toFixed(1)}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px;"><strong>Magnesium (Mg¬≤‚Å∫)</strong></td>
                                        <td style="text-align: right; padding: 8px;">${dialysate.Mg.toFixed(2)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px;">${(dialysate.Mg * dilutionFactor).toFixed(2)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px;">${((dialysate.Mg * dilutionFactor) - dialysate.Mg) > 0 ? '+' : ''}${((dialysate.Mg * dilutionFactor) - dialysate.Mg).toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px;"><strong>Glucose</strong></td>
                                        <td style="text-align: right; padding: 8px;">${dialysate.Glucose.toFixed(1)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px;">${(dialysate.Glucose * dilutionFactor).toFixed(1)} mmol/L</td>
                                        <td style="text-align: right; padding: 8px;">${((dialysate.Glucose * dilutionFactor) - dialysate.Glucose) > 0 ? '+' : ''}${((dialysate.Glucose * dilutionFactor) - dialysate.Glucose).toFixed(1)}</td>
                                    </tr>
                                    <tr style="border-top: 2px solid var(--light-bg);">
                                        <td style="padding: 8px;"><strong>Osmolality (approx)</strong></td>
                                        <td style="text-align: right; padding: 8px;">${baseOsmolality.toFixed(0)} mOsm/L</td>
                                        <td style="text-align: right; padding: 8px;">${finalOsmolality.toFixed(0)} mOsm/L</td>
                                        <td style="text-align: right; padding: 8px;">${(finalOsmolality - baseOsmolality) > 0 ? '+' : ''}${(finalOsmolality - baseOsmolality).toFixed(0)}</td>
                                    </tr>
                                `;
                            })()}
                        </tbody>
                    </table>
                    ${(() => {
                        const dilutionFactor = (bagVolume - result.volumeToRemove) / bagVolume;
                        const finalK = dialysate.K * dilutionFactor;
                        const finalHCO3 = dialysate.HCO3 * dilutionFactor;
                        const kDropped = dialysate.K - finalK;
                        const hco3Dropped = dialysate.HCO3 - finalHCO3;
                        
                        // Show warnings if K drops >0.5 OR HCO3 drops >2
                        if (kDropped > 0.5 || hco3Dropped > 2) {
                            return `
                                <div style="background: #FFE5E5; padding: 10px; border-radius: 4px; margin-top: 10px; border-left: 3px solid var(--nhs-red);">
                                    <strong>‚ö†Ô∏è Electrolyte Dilution Warnings:</strong>
                                    <ul style="margin-left: 20px; margin-top: 5px; font-size: 13px;">
                                        ${kDropped > 0.5 ? 
                                            `<li><strong>K+ diluted by ${kDropped.toFixed(1)} mmol/L</strong> - consider potassium supplementation</li>` : ''}
                                        ${hco3Dropped > 2 ? 
                                            `<li><strong>HCO3- diluted by ${hco3Dropped.toFixed(1)} mmol/L</strong> - monitor acid-base status closely</li>` : ''}
                                    </ul>
                                    <p style="margin: 10px 0 0 0; font-size: 13px; color: #666;">
                                        <em>Note: ${additiveName === 'sterile-water' ? 'Sterile water' : 'NaCl additives'} contain${additiveName === 'sterile-water' ? 's' : ''} no potassium or bicarbonate, so removing ${result.volumeToRemove.toFixed(0)} mL of base dialysate dilutes these electrolytes.</em>
                                    </p>
                                </div>
                            `;
                        }
                        return '';
                    })()}
                </div>
                
                <div class="two-column" style="margin-top: 15px;">
                    <div class="tool-card" style="margin: 0;">
                        <h3>Clinical Monitoring</h3>
                        <ul style="margin-left: 20px; font-size: 13px; line-height: 1.6;">
                            <li>Check serum Na+ every 4-6 hours</li>
                            <li>Maximum correction: 8-10 mmol/L per 24h</li>
                            <li>If Na+ changes >2 mmol/L in 6h: Reduce RRT rate or change fluid</li>
                        </ul>
                    </div>
                    
                    <div class="tool-card" style="margin: 0; border-left: 5px solid var(--nhs-orange); background: #FFF4E5;">
                        <h3>‚ö†Ô∏è Mandatory Requirements</h3>
                        <ul style="margin-left: 20px; font-size: 13px; line-height: 1.6;">
                            <li><strong>‚úì Consultant approval obtained</strong></li>
                            <li><strong>‚úì Band 6+ nurse second-check</strong></li>
                            <li><strong>‚úì Documented in patient notes</strong></li>
                            <li><strong>‚úì Bag labelled with modification</strong></li>
                        </ul>
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }
        
        // Acid-Base Calculator
        // Acid-Base Calculator
        function calculateAcidBase() {
            // Get all inputs
            const pH = parseFloat(document.getElementById('ab-ph').value);
            const pCO2 = parseFloat(document.getElementById('ab-pco2').value);
            const BE = parseFloat(document.getElementById('ab-be').value);
            const HCO3 = parseFloat(document.getElementById('ab-hco3').value);
            const Na = parseFloat(document.getElementById('ab-na').value);
            const K = parseFloat(document.getElementById('ab-k').value);
            const Cl = parseFloat(document.getElementById('ab-cl').value);
            const albumin = parseFloat(document.getElementById('ab-albumin').value);
            const clearance = parseFloat(document.getElementById('ab-clearance').value);
            const urea = parseFloat(document.getElementById('ab-urea').value);
            const ureaTrend = document.getElementById('ab-urea-trend').value;
            const creatinine = parseFloat(document.getElementById('ab-creatinine').value);
            const creatTrend = document.getElementById('ab-creat-trend').value;
            
            // Get citrate accumulation status
            const citrateAccumYes = document.getElementById('citrate-yes');
            const citrateAccumNo = document.getElementById('citrate-no');
            const citrateAccum = citrateAccumYes?.checked ? 'yes' : (citrateAccumNo?.checked ? 'no' : null);
            
            // Get anticoagulation from top of page
            const anticoag = document.getElementById('anticoag')?.value || '';
            document.getElementById('ab-anticoag-display').textContent = anticoag ? 
                (anticoag === 'citrate' ? 'Citrate (Ci-Ca¬Æ)' : 
                 anticoag === 'heparin' ? 'Heparin' : 
                 anticoag === 'epoprostenol' ? 'Epoprostenol' : 'None') : 
                'Not selected';
            
            const resultsDiv = document.getElementById('acidbase-results');
            
            // Check if minimum required fields entered
            if (!pH || !BE || !HCO3) {
                resultsDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Enter pH, Base Excess, and Bicarbonate to begin analysis</p>';
                return;
            }
            
            // CRITICAL pH CHECK - Emergency protocol
            if (pH < 7.0) {
                resultsDiv.innerHTML = `
                    <div style="background: #FFE5E5; padding: 20px; border-radius: 8px; border: 3px solid #DA291C; margin-bottom: 20px;">
                        <h3 style="color: #DA291C; margin-top: 0;">üö® CRITICAL pH (<7.0)</h3>
                        <div style="font-size: 16px; line-height: 1.8;">
                            <strong>IMMEDIATE ACTIONS REQUIRED:</strong><br>
                            1. <strong>INFORM CLINICIAN IMMEDIATELY</strong><br>
                            2. Give <strong>100mL 8.4% NaHCO‚ÇÉ IV bolus</strong><br>
                            3. Reassess pH in 30 minutes<br>
                            4. Continue acid-base analysis below
                        </div>
                    </div>
                `;
                // Continue with rest of analysis but show emergency first
            } else {
                resultsDiv.innerHTML = '';
            }
            
            // Calculate anion gap (corrected for albumin)
            let anionGap = null;
            if (Na && K && Cl && HCO3 && albumin) {
                // AG = (Na + K) - (Cl + HCO3)
                // Corrected AG = AG + 0.25 √ó (40 - albumin)
                const uncorrectedAG = (Na + K) - (Cl + HCO3);
                anionGap = uncorrectedAG + 0.25 * (40 - albumin);
            }
            
            // Determine pH status
            let pHStatus, pHColor;
            if (pH < 7.35) {
                if (pH < 7.05) {
                    pHStatus = 'Very Severe Acidosis';
                    pHColor = '#8B0000';
                } else if (pH < 7.15) {
                    pHStatus = 'Severe Acidosis';
                    pHColor = '#DA291C';
                } else if (pH < 7.25) {
                    pHStatus = 'Moderate Acidosis';
                    pHColor = '#ED8B00';
                } else {
                    pHStatus = 'Mild Acidosis';
                    pHColor = '#F4A460';
                }
            } else if (pH > 7.45) {
                if (pH > 7.71) {
                    pHStatus = 'Very Severe Alkalosis';
                    pHColor = '#8B0000';
                } else if (pH > 7.61) {
                    pHStatus = 'Severe Alkalosis';
                    pHColor = '#DA291C';
                } else if (pH > 7.56) {
                    pHStatus = 'Moderate Alkalosis';
                    pHColor = '#ED8B00';
                } else {
                    pHStatus = 'Mild Alkalosis';
                    pHColor = '#F4A460';
                }
            } else {
                pHStatus = 'Normal pH';
                pHColor = '#007F3B';
            }
            
            // Determine metabolic component
            let metabolicStatus = 'Normal';
            if (BE < -5) {
                // Base excess clearly indicates acidosis
                metabolicStatus = 'Metabolic Acidosis';
            } else if (BE > 5) {
                // Base excess clearly indicates alkalosis
                metabolicStatus = 'Metabolic Alkalosis';
            } else if (pH < 7.35 && BE >= -5) {
                // pH acidotic but BE not significantly low - likely respiratory
                if (pCO2 && pCO2 > 6.0) {
                    // Predominantly respiratory
                    metabolicStatus = 'Normal';
                } else {
                    // Likely some metabolic component
                    metabolicStatus = 'Metabolic Acidosis';
                }
            } else if (pH > 7.45 && BE <= 5) {
                // pH alkalotic but BE not significantly high - likely respiratory
                if (pCO2 && pCO2 < 4.5) {
                    // Predominantly respiratory
                    metabolicStatus = 'Normal';
                } else {
                    // Likely some metabolic component
                    metabolicStatus = 'Metabolic Alkalosis';
                }
            }
            
            // Determine respiratory component
            let respiratoryStatus = 'Normal';
            if (pCO2) {
                if (pCO2 > 6.0) {
                    respiratoryStatus = 'Respiratory Acidosis';
                } else if (pCO2 < 4.5) {
                    respiratoryStatus = 'Respiratory Alkalosis';
                }
            }
            
            // Determine primary disturbance and compensation
            let primaryDisturbance = 'None';
            let compensation = 'N/A';
            
            if (metabolicStatus !== 'Normal' || respiratoryStatus !== 'Normal') {
                // Primary is whichever matches the pH direction
                if (pH < 7.35) {
                    // Acidotic
                    if (metabolicStatus === 'Metabolic Acidosis') {
                        primaryDisturbance = 'Metabolic Acidosis';
                        if (respiratoryStatus === 'Respiratory Alkalosis') {
                            compensation = 'Partial Respiratory Compensation';
                        } else if (respiratoryStatus === 'Normal') {
                            compensation = 'No Respiratory Compensation';
                        } else {
                            compensation = 'Mixed Disorder';
                        }
                    } else if (respiratoryStatus === 'Respiratory Acidosis') {
                        primaryDisturbance = 'Respiratory Acidosis';
                        if (metabolicStatus === 'Metabolic Alkalosis') {
                            compensation = 'Partial Metabolic Compensation';
                        } else {
                            compensation = 'No Metabolic Compensation';
                        }
                    }
                } else if (pH > 7.45) {
                    // Alkalotic
                    if (metabolicStatus === 'Metabolic Alkalosis') {
                        primaryDisturbance = 'Metabolic Alkalosis';
                        if (respiratoryStatus === 'Respiratory Acidosis') {
                            compensation = 'Partial Respiratory Compensation';
                        } else if (respiratoryStatus === 'Normal') {
                            compensation = 'No Respiratory Compensation';
                        } else {
                            compensation = 'Mixed Disorder';
                        }
                    } else if (respiratoryStatus === 'Respiratory Alkalosis') {
                        primaryDisturbance = 'Respiratory Alkalosis';
                        if (metabolicStatus === 'Metabolic Acidosis') {
                            compensation = 'Partial Metabolic Compensation';
                        } else {
                            compensation = 'No Metabolic Compensation';
                        }
                    }
                }
            }
            
            // Determine anion gap status
            let anionGapStatus = '';
            if (anionGap !== null) {
                if (anionGap > 18) {
                    anionGapStatus = '<strong style="color: #DA291C;">High Anion Gap</strong>';
                } else if (anionGap > 16) {
                    anionGapStatus = '<strong style="color: #ED8B00;">Borderline High Anion Gap</strong>';
                } else {
                    anionGapStatus = '<strong style="color: #007F3B;">Normal Anion Gap</strong>';
                }
            }
            
            // Assess clearance adequacy
            let clearanceAdequate = null;
            if (clearance && ureaTrend && creatTrend) {
                // Adequate if clearance >20 AND urea/creat stable or falling
                if (clearance >= 20 && (ureaTrend === 'stable' || ureaTrend === 'falling') && 
                    (creatTrend === 'stable' || creatTrend === 'falling')) {
                    clearanceAdequate = true;
                } else {
                    clearanceAdequate = false;
                }
            }
            
            // Check for filter pore blockage signs (for metabolic alkalosis with inadequate clearance)
            let filterBlockageSigns = false;
            if (Na && Cl && HCO3) {
                // Na>155, Cl>120, HCO3>30, (and we check Ca in ratio calculator)
                if (Na > 155 && Cl > 120 && HCO3 > 30) {
                    filterBlockageSigns = true;
                }
            }
            
            // BUILD RESULTS HTML
            let html = resultsDiv.innerHTML; // Keep emergency warning if present
            
            // TWO-COLUMN LAYOUT: Summary | Management
            html += `<div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px; margin-bottom: 20px;">`;
            
            // LEFT: SUMMARY BOX
            html += `
                <div style="background: white; border: 2px solid ${pHColor}; border-radius: 8px; padding: 20px;">
                    <h3 style="color: ${pHColor}; margin: 0 0 15px 0; font-size: 18px;">Acid-Base Summary</h3>
                    <div style="font-size: 14px; line-height: 2;">
                        <div>
                            <strong>Status:</strong> 
                            <span style="color: ${pHColor}; font-weight: bold;">${pHStatus} (pH = ${pH.toFixed(2)})</span>
                        </div>
                        <div>
                            <strong>Primary Disturbance:</strong> 
                            <span style="font-weight: 600;">${primaryDisturbance}</span>
                        </div>
                        <div>
                            <strong>Compensation:</strong> 
                            <span>${compensation}</span>
                        </div>
                        ${anionGap !== null ? `
                        <div>
                            <strong>Anion Gap (corrected):</strong> 
                            ${anionGapStatus} <span style="color: #666;">(${anionGap.toFixed(1)} mmol/L)</span>
                        </div>
                        ` : ''}
                        ${clearanceAdequate !== null ? `
                        <div>
                            <strong>RRT Clearance:</strong> 
                            <span style="font-weight: bold; color: ${clearanceAdequate ? '#007F3B' : '#DA291C'};">
                                ${clearanceAdequate ? 'Adequate' : 'Inadequate'}
                            </span>
                            <span style="color: #666;">(${clearance} mL/kg/h)</span>
                        </div>
                        ` : ''}
                        ${generateVentilationSuggestion(pCO2, metabolicStatus) ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #ddd;">
                            ${generateVentilationSuggestion(pCO2, metabolicStatus)}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // RIGHT: MANAGEMENT RECOMMENDATIONS
            html += '<div style="background: white; border: 2px solid #ddd; border-radius: 8px; padding: 20px;">';
            
            // MANAGEMENT RECOMMENDATIONS (inside the right column div already opened)
            if (metabolicStatus === 'Metabolic Acidosis') {
                html += generateMetabolicAcidosisRecommendations(clearanceAdequate, citrateAccum, anticoag);
            } else if (metabolicStatus === 'Metabolic Alkalosis') {
                html += generateMetabolicAlkalosisRecommendations(clearanceAdequate, citrateAccum, anticoag, filterBlockageSigns);
            } else {
                html += `
                    <h3 style="color: #007F3B; margin: 0 0 10px 0; font-size: 16px;">‚úì No Metabolic Disturbance</h3>
                    <p style="margin: 0;">pH and base excess within normal range. Continue current RRT settings and monitor regularly.</p>
                `;
            }
            html += '</div>'; // Close management div
            html += '</div>'; // Close two-column grid
            
            // CAUSES BOX (full width below summary and management)
            if (metabolicStatus === 'Metabolic Acidosis' && anionGap !== null) {
                html += generateCausesBox(metabolicStatus, anionGap);
            } else if (metabolicStatus === 'Metabolic Alkalosis') {
                html += generateCausesBox(metabolicStatus, null);
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function generateVentilationSuggestion(pCO2, metabolicStatus) {
            if (!pCO2 || !metabolicStatus) return '';
            
            // Check for inappropriate respiratory compensation
            if (metabolicStatus === 'Metabolic Acidosis' && pCO2 > 6.0) {
                // Hypercarbic in context of acidosis - inadequate compensation
                return `<strong style="color: #ED8B00;">‚ö†Ô∏è Ventilation:</strong> <span>Suggest modify ventilation to optimise pCO‚ÇÇ to compensate</span>`;
            } else if (metabolicStatus === 'Metabolic Alkalosis' && pCO2 < 4.5) {
                // Hypocarbic in context of alkalosis - inadequate compensation
                return `<strong style="color: #ED8B00;">‚ö†Ô∏è Ventilation:</strong> <span>Suggest modify ventilation to optimise pCO‚ÇÇ to compensate</span>`;
            }
            
            return '';
        }
        
        function generateCausesBox(metabolicStatus, anionGap) {
            let html = `
                <div style="background: #E6F2FF; border: 2px solid #005EB8; border-radius: 8px; padding: 20px; margin-top: 20px;">
                    <h3 style="color: #005EB8; margin: 0 0 15px 0; font-size: 16px;">Common Causes</h3>
            `;
            
            if (metabolicStatus === 'Metabolic Acidosis') {
                if (anionGap > 18) {
                    // High Anion Gap Metabolic Acidosis
                    html += `
                        <div style="font-size: 14px;">
                            <strong style="color: #DA291C;">High Anion Gap Metabolic Acidosis</strong>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 5px;">Metabolic</div>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                        <li>Lactic acidosis (Type A & B)</li>
                                        <li>Ketoacidosis (DKA, alcoholic, starvation)</li>
                                        <li>Uraemia (acute/chronic kidney injury)</li>
                                    </ul>
                                </div>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 5px;">Ingestions</div>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                        <li>Methanol</li>
                                        <li>Ethylene glycol</li>
                                        <li>Salicylates</li>
                                        <li>Paracetamol (late)</li>
                                    </ul>
                                </div>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 5px;">Other</div>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                        <li>Propofol infusion syndrome</li>
                                        <li>5-oxoproline (chronic paracetamol)</li>
                                        <li>D-lactic acidosis</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Normal Anion Gap Metabolic Acidosis
                    html += `
                        <div style="font-size: 14px;">
                            <strong style="color: #007F3B;">Normal Anion Gap Metabolic Acidosis (Hyperchloraemic)</strong>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 5px;">GI Losses</div>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                        <li>Diarrhoea</li>
                                        <li>High-output stoma</li>
                                        <li>Fistulae</li>
                                        <li>Ureterosigmoidostomy</li>
                                    </ul>
                                </div>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 5px;">Renal</div>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                        <li>Renal tubular acidosis (Types 1, 2, 4)</li>
                                        <li>Carbonic anhydrase inhibitors</li>
                                        <li>Post-hypocapnia</li>
                                    </ul>
                                </div>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 5px;">Iatrogenic</div>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                        <li>0.9% saline resuscitation</li>
                                        <li>TPN</li>
                                        <li>Drugs (e.g., acetazolamide)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else if (metabolicStatus === 'Metabolic Alkalosis') {
                html += `
                    <div style="font-size: 14px;">
                        <strong style="color: #005EB8;">Metabolic Alkalosis</strong>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Volume Depletion</div>
                                <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                    <li>Vomiting / NG drainage</li>
                                    <li>Diuretics (loop, thiazide)</li>
                                    <li>Post-hypercapnia</li>
                                    <li>Contraction alkalosis</li>
                                </ul>
                            </div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Excess Alkali</div>
                                <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                    <li>Bicarbonate therapy</li>
                                    <li>Citrate metabolism (RRT/blood products)</li>
                                    <li>Milk-alkali syndrome</li>
                                </ul>
                            </div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Other</div>
                                <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                    <li>Hypokalaemia</li>
                                    <li>Hyperaldosteronism</li>
                                    <li>Cushing's syndrome</li>
                                    <li>RRT filter pore blockage</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
            return html;
        }
        
        function generateMetabolicAcidosisRecommendations(clearanceAdequate, citrateAccum, anticoag) {
            let html = `
                <h3 style="color: #DA291C; margin: 0 0 10px 0; font-size: 16px;">Metabolic Acidosis Management</h3>
                <p style="font-weight: 600; margin-bottom: 15px; font-size: 14px;">Make ONE change at a time, then reassess before proceeding to next step</p>
            `;
            
            // Handle non-citrate anticoagulation
            if (anticoag !== 'citrate') {
                html += `
                    <div style="background: #E6F2FF; padding: 15px; border-radius: 4px; border-left: 5px solid #005EB8; margin-bottom: 15px;">
                        <strong style="color: #005EB8;">Anticoagulation: ${anticoag === 'heparin' ? 'Heparin' : anticoag === 'epoprostenol' ? 'Epoprostenol' : 'None'}</strong>
                        <p style="margin: 10px 0 0 0; font-size: 14px;">With non-citrate anticoagulation, bicarbonate cannot be adjusted via citrate dose.</p>
                    </div>
                    <ol style="line-height: 1.8; font-size: 14px; margin: 0; padding-left: 20px;">
                        <li><strong>Increase blood flow rate by 20%</strong><br>
                            <span style="font-size: 13px;">‚Üí Increases clearance of acidic metabolites</span>
                        </li>
                        <li><strong>Increase dialysate flow rate by 20%</strong><br>
                            <span style="font-size: 13px;">‚Üí Increases bicarbonate delivery from dialysate</span>
                        </li>
                        <li><strong>Change filter set</strong><br>
                            <span style="font-size: 13px;">‚Üí May improve if filter performance degraded</span>
                        </li>
                    </ol>
                `;
                return html;
            }
            
            if (clearanceAdequate === null) {
                html += `<p style="background: #FFF4E5; padding: 10px; border-radius: 4px; font-size: 13px;">‚ö†Ô∏è Enter clearance and urea/creatinine trends to see specific recommendations</p>`;
            } else if (clearanceAdequate) {
                // ADEQUATE CLEARANCE
                html += `
                    <div style="background: rgba(0,127,59,0.1); padding: 10px; border-radius: 4px; margin-bottom: 12px; font-size: 13px;">
                        <strong>‚úì RRT Clearance: ADEQUATE</strong>
                    </div>
                    <ol style="line-height: 1.8; font-size: 14px; margin: 0; padding-left: 20px;">
                `;
                
                // Step 1: Citrate accumulation check
                if (citrateAccum === 'yes') {
                    html += `
                        <li><strong style="color: #DA291C;">‚ö†Ô∏è Citrate Accumulation Present</strong><br>
                            <span style="font-size: 13px;">‚Üí <strong>CLINICIAN REVIEW REQUIRED</strong></span><br>
                            <span style="font-size: 13px;">‚Üí Consider alternative anticoagulant</span>
                        </li>
                    `;
                } else if (citrateAccum === 'no') {
                    html += `<li style="font-size: 13px;">‚úì No citrate accumulation - proceed with steps below</li>`;
                } else {
                    html += `<li style="font-size: 13px;">‚ö†Ô∏è Check for citrate accumulation first (Ca Ratio Calculator)</li>`;
                }
                
                html += `
                        <li><strong>Increase blood flow by 20%</strong> (up to max for filter)<br>
                            <span style="font-size: 13px;">‚Üí Improves clearance AND increases citrate/bicarbonate delivery</span>
                        </li>
                        <li><strong>Increase citrate dose by 20%</strong> (post-filter iCa to 0.20 mmol/L)<br>
                            <span style="font-size: 13px;">‚Üí Citrate is metabolised to bicarbonate - may help correct acidosis</span>
                        </li>
                        <li><strong>Reduce dialysate flow by 20%</strong><br>
                            <span style="font-size: 13px;">‚Üí More citrate (bicarbonate) delivered to patient, less HCO‚ÇÉ loss</span>
                        </li>
                        <li><strong>Change filter set</strong><br>
                            <span style="font-size: 13px;">‚Üí May improve if filter performance degraded</span>
                        </li>
                    </ol>
                `;
            } else {
                // INADEQUATE CLEARANCE
                html += `
                    <div style="background: rgba(218,41,28,0.1); padding: 10px; border-radius: 4px; margin-bottom: 12px; font-size: 13px;">
                        <strong>‚úó RRT Clearance: INADEQUATE</strong>
                    </div>
                    <ol style="line-height: 1.8; font-size: 14px; margin: 0; padding-left: 20px;">
                `;
                
                // Step 1: Citrate accumulation check
                if (citrateAccum === 'yes') {
                    html += `
                        <li><strong style="color: #DA291C;">‚ö†Ô∏è Citrate Accumulation Present</strong><br>
                            <span style="font-size: 13px;">‚Üí <strong>CLINICIAN REVIEW REQUIRED</strong></span><br>
                            <span style="font-size: 13px;">‚Üí Consider alternative anticoagulant</span>
                        </li>
                    `;
                } else if (citrateAccum === 'no') {
                    html += `<li style="font-size: 13px;">‚úì No citrate accumulation - proceed with steps below</li>`;
                } else {
                    html += `<li style="font-size: 13px;">‚ö†Ô∏è Check for citrate accumulation first</li>`;
                }
                
                html += `
                        <li><strong>Increase blood flow by 20%</strong> (up to max for filter)<br>
                            <span style="font-size: 13px;">‚Üí Critical: improves clearance AND bicarbonate delivery</span>
                        </li>
                        <li><strong>Increase citrate dose by 20%</strong> (post-filter iCa to 0.20 mmol/L)<br>
                            <span style="font-size: 13px;">‚Üí Citrate metabolised to bicarbonate - may help acidosis</span>
                        </li>
                        <li><strong>Change filter set</strong><br>
                            <span style="font-size: 13px;">‚Üí May improve clearance if filter degraded</span>
                        </li>
                    </ol>
                    <div style="background: #FFF4E5; padding: 10px; border-radius: 4px; margin-top: 12px; border-left: 3px solid #ED8B00; font-size: 13px;">
                        <strong>‚ö†Ô∏è Note:</strong> Do NOT reduce dialysate - would worsen clearance
                    </div>
                `;
            }
            
            return html;
        }
        
        function generateMetabolicAlkalosisRecommendations(clearanceAdequate, citrateAccum, anticoag, filterBlockageSigns) {
            let html = `
                <h3 style="color: #005EB8; margin: 0 0 10px 0; font-size: 16px;">Metabolic Alkalosis Management</h3>
                <p style="font-weight: 600; margin-bottom: 15px; font-size: 14px;">Make ONE change at a time, then reassess before proceeding to next step</p>
            `;
            
            // Handle non-citrate anticoagulation
            if (anticoag !== 'citrate') {
                html += `
                    <div style="background: #E6F2FF; padding: 15px; border-radius: 4px; border-left: 5px solid #005EB8; margin-bottom: 15px;">
                        <strong style="color: #005EB8;">Anticoagulation: ${anticoag === 'heparin' ? 'Heparin' : anticoag === 'epoprostenol' ? 'Epoprostenol' : 'None'}</strong>
                        <p style="margin: 10px 0 0 0; font-size: 14px;">With non-citrate anticoagulation, bicarbonate cannot be adjusted via citrate dose.</p>
                    </div>
                    <ol style="line-height: 1.8; font-size: 14px; margin: 0; padding-left: 20px;">
                        <li><strong>Reduce blood flow rate by 20%</strong> (minimum 80 mL/min)<br>
                            <span style="font-size: 13px;">‚Üí Reduces bicarbonate uptake from dialysate</span>
                        </li>
                        <li><strong>Reduce dialysate flow rate by 20%</strong><br>
                            <span style="font-size: 13px;">‚Üí Reduces bicarbonate delivery from dialysate</span>
                        </li>
                        <li><strong>Change filter set</strong><br>
                            <span style="font-size: 13px;">‚Üí May help if filter performance issue</span>
                        </li>
                    </ol>
                `;
                return html;
            }
            
            if (clearanceAdequate === null) {
                html += `<p style="background: #FFF4E5; padding: 10px; border-radius: 4px; font-size: 13px;">‚ö†Ô∏è Enter clearance and urea/creatinine trends to see specific recommendations</p>`;
            } else if (clearanceAdequate) {
                // ADEQUATE CLEARANCE
                html += `
                    <div style="background: rgba(0,127,59,0.1); padding: 10px; border-radius: 4px; margin-bottom: 12px; font-size: 13px;">
                        <strong>‚úì RRT Clearance: ADEQUATE</strong>
                    </div>
                    <ol style="line-height: 1.8; font-size: 14px; margin: 0; padding-left: 20px;">
                `;
                
                // Step 1: Citrate accumulation check
                if (citrateAccum === 'yes') {
                    html += `
                        <li><strong style="color: #DA291C;">‚ö†Ô∏è Citrate Accumulation Present</strong><br>
                            <span style="font-size: 13px;">‚Üí <strong>CLINICIAN REVIEW REQUIRED</strong></span><br>
                            <span style="font-size: 13px;">‚Üí Consider alternative anticoagulant</span>
                        </li>
                    `;
                } else if (citrateAccum === 'no') {
                    html += `<li style="font-size: 13px;">‚úì No citrate accumulation - proceed with steps below</li>`;
                } else {
                    html += `<li style="font-size: 13px;">‚ö†Ô∏è Check for citrate accumulation first</li>`;
                }
                
                html += `
                        <li><strong>Reduce blood flow by 20%</strong> (down to minimum 80 mL/min)<br>
                            <span style="font-size: 13px;">‚Üí Reduces citrate/bicarbonate delivery to patient</span>
                        </li>
                        <li><strong>Reduce citrate dose by 20%</strong> (allow post-filter iCa to 0.40 mmol/L)<br>
                            <span style="font-size: 13px;">‚Üí Citrate metabolised to HCO‚ÇÉ - less citrate = less alkalosis</span>
                        </li>
                        <li><strong>Increase dialysate flow by 20%</strong><br>
                            <span style="font-size: 13px;">‚Üí Increases bicarbonate loss into effluent</span>
                        </li>
                        <li><strong>Change filter set</strong><br>
                            <span style="font-size: 13px;">‚Üí May help if filter performance issue</span>
                        </li>
                    </ol>
                `;
            } else {
                // INADEQUATE CLEARANCE
                html += `
                    <div style="background: rgba(218,41,28,0.1); padding: 10px; border-radius: 4px; margin-bottom: 12px; font-size: 13px;">
                        <strong>‚úó RRT Clearance: INADEQUATE</strong>
                    </div>
                `;
                
                // Check for filter blockage first
                if (filterBlockageSigns) {
                    html += `
                        <div style="background: #FFE5E5; padding: 12px; border-radius: 4px; margin-bottom: 12px; border: 2px solid #DA291C; font-size: 13px;">
                            <strong style="color: #DA291C;">‚ö†Ô∏è FILTER PORE BLOCKAGE DETECTED</strong><br>
                            <span style="font-size: 13px;">Na >155, Cl >120, HCO‚ÇÉ >30</span><br>
                            <span style="font-size: 14px; font-weight: 600;">‚Üí <strong>CHANGE FILTER SET FIRST</strong></span>
                        </div>
                    `;
                }
                
                html += `<ol style="line-height: 1.8; font-size: 14px; margin: 0; padding-left: 20px;">`;
                
                if (filterBlockageSigns) {
                    html += `<li><strong>Change filter set</strong> (blockage signs present)</li>`;
                }
                
                // Citrate accumulation check
                if (citrateAccum === 'yes') {
                    html += `
                        <li><strong style="color: #DA291C;">‚ö†Ô∏è Citrate Accumulation Present</strong><br>
                            <span style="font-size: 13px;">‚Üí <strong>CLINICIAN REVIEW REQUIRED</strong></span><br>
                            <span style="font-size: 13px;">‚Üí Consider alternative anticoagulant</span>
                        </li>
                    `;
                } else if (citrateAccum === 'no') {
                    html += `<li style="font-size: 13px;">‚úì No citrate accumulation - proceed with steps below</li>`;
                } else {
                    html += `<li style="font-size: 13px;">‚ö†Ô∏è Check for citrate accumulation first</li>`;
                }
                
                html += `
                        <li><strong>Increase dialysate flow by 20%</strong> (don't change blood flow)<br>
                            <span style="font-size: 13px;">‚Üí Improves clearance AND increases HCO‚ÇÉ loss</span>
                        </li>
                        <li><strong>Reduce citrate dose by 20%</strong> (allow post-filter iCa to 0.40 mmol/L)<br>
                            <span style="font-size: 13px;">‚Üí Less citrate metabolised to bicarbonate</span>
                        </li>
                        <li><strong>Change filter set</strong> (if not already done)<br>
                            <span style="font-size: 13px;">‚Üí May improve clearance</span>
                        </li>
                    </ol>
                    <div style="background: #FFF4E5; padding: 10px; border-radius: 4px; margin-top: 12px; border-left: 3px solid #ED8B00; font-size: 13px;">
                        <strong>‚ö†Ô∏è Note:</strong> Do NOT reduce blood flow - priority is improving clearance
                    </div>
                `;
            }
            
            return html;
        }
        
        // Filter Age Calculator
        function calculateFilterAge() {
            const filterChanged = document.getElementById('filter-changed').value;
            const filterAgeDisplay = document.getElementById('filter-age-display');
            const accessFilterAge = document.getElementById('access-filter-age');
            
            if (!filterChanged) {
                filterAgeDisplay.innerHTML = '‚Äî';
                filterAgeDisplay.style.background = '#f0f0f0';
                filterAgeDisplay.style.color = '#666';
                if (accessFilterAge) {
                    accessFilterAge.innerHTML = 'Not set';
                    accessFilterAge.style.background = '#f0f0f0';
                    accessFilterAge.style.color = '#666';
                }
                return;
            }
            
            const changedDate = new Date(filterChanged);
            const now = new Date();
            const ageHours = (now - changedDate) / (1000 * 60 * 60); // Convert ms to hours
            
            let displayText = '';
            let bgColor = '';
            let textColor = '#fff';
            
            if (ageHours < 0) {
                displayText = 'Invalid date (future)';
                bgColor = '#666';
            } else if (ageHours < 72) {
                displayText = `${Math.round(ageHours)}h`;
                bgColor = '#007F3B'; // Green
            } else if (ageHours <= 96) {
                displayText = `${Math.round(ageHours)}h`;
                bgColor = '#ED8B00'; // Amber
            } else {
                displayText = `${Math.round(ageHours)}h - Consider change`;
                bgColor = '#DA291C'; // Red
            }
            
            filterAgeDisplay.innerHTML = displayText;
            filterAgeDisplay.style.background = bgColor;
            filterAgeDisplay.style.color = textColor;
            
            if (accessFilterAge) {
                accessFilterAge.innerHTML = displayText;
                accessFilterAge.style.background = bgColor;
                accessFilterAge.style.color = textColor;
            }
        }
        
        // Vascath Age Calculator
        function calculateVascathAge() {
            const insertionDate = document.getElementById('vascath-inserted').value;
            const vascathAgeDisplay = document.getElementById('vascath-age-display');
            
            if (!insertionDate) {
                vascathAgeDisplay.innerHTML = '‚Äî';
                vascathAgeDisplay.style.background = '#f0f0f0';
                vascathAgeDisplay.style.color = '#666';
                return;
            }
            
            const inserted = new Date(insertionDate);
            const now = new Date();
            const ageHours = (now - inserted) / (1000 * 60 * 60); // Convert ms to hours
            
            let displayText = '';
            let bgColor = '';
            let textColor = '#fff';
            
            if (ageHours < 0) {
                displayText = 'Invalid date (future)';
                bgColor = '#666';
            } else if (ageHours < 144) {
                // <144h: Green
                displayText = `${Math.round(ageHours)}h`;
                bgColor = '#007F3B';
            } else if (ageHours <= 168) {
                // 145-168h: Amber
                displayText = `${Math.round(ageHours)}h`;
                bgColor = '#ED8B00';
            } else {
                // >168h: Red
                displayText = `${Math.round(ageHours)}h`;
                bgColor = '#DA291C';
            }
            
            vascathAgeDisplay.innerHTML = displayText;
            vascathAgeDisplay.style.background = bgColor;
            vascathAgeDisplay.style.color = textColor;
        }
        
        // Update anticoagulation displays across all tabs
        function updateAnticoagDisplays() {
            const anticoag = document.getElementById('anticoag')?.value || '';
            const displayText = anticoag ? 
                (anticoag === 'citrate' ? 'Citrate (Ci-Ca¬Æ)' : 
                 anticoag === 'heparin' ? 'Heparin' : 
                 anticoag === 'epoprostenol' ? 'Epoprostenol' : 'None') : 
                'Not selected';
            
            // Update Acid-Base tab display
            const abAnticoagDisplay = document.getElementById('ab-anticoag-display');
            if (abAnticoagDisplay) {
                abAnticoagDisplay.textContent = displayText;
            }
            
            // Update Sodium Correction tab display
            const sodiumAnticoagDisplay = document.getElementById('sodium-anticoag-display');
            if (sodiumAnticoagDisplay) {
                sodiumAnticoagDisplay.textContent = displayText;
            }
        }
        
        // Access Age Calculator (keep original for Access tab compatibility)
        function calculateAccessAge() {
            const insertionDate = document.getElementById('access-insertion-date').value;
            const accessAgeDisplay = document.getElementById('access-age-display');
            
            if (!insertionDate) {
                accessAgeDisplay.innerHTML = 'Catheter Age: ‚Äî';
                return;
            }
            
            const inserted = new Date(insertionDate);
            const now = new Date();
            const ageDays = (now - inserted) / (1000 * 60 * 60 * 24);
            
            if (ageDays < 0) {
                accessAgeDisplay.innerHTML = 'Catheter Age: Invalid date (future)';
                accessAgeDisplay.style.color = '#DA291C';
            } else if (ageDays < 1) {
                accessAgeDisplay.innerHTML = `Catheter Age: ${Math.round(ageDays * 24)} hours`;
                accessAgeDisplay.style.color = '#007F3B';
            } else {
                accessAgeDisplay.innerHTML = `Catheter Age: ${Math.round(ageDays)} days`;
                accessAgeDisplay.style.color = ageDays > 14 ? '#ED8B00' : '#007F3B';
            }
        }
        
        // Access & Filter Issues - Add Monitoring Row
        let accessRowCount = 0;
        function addAccessMonitoringRow() {
            accessRowCount++;
            const tbody = document.getElementById('access-monitoring-body');
            const row = tbody.insertRow();
            row.id = `access-row-${accessRowCount}`;
            
            row.innerHTML = `
                <td><input type="datetime-local" id="access-dt-${accessRowCount}" style="width: 100%; min-width: 140px;" onchange="analyzeAccessIssues()"></td>
                <td><input type="number" id="access-pressure-${accessRowCount}" placeholder="-150" step="1" style="width: 80px;" oninput="analyzeAccessIssues()"></td>
                <td><input type="number" id="return-pressure-${accessRowCount}" placeholder="150" step="1" style="width: 80px;" oninput="analyzeAccessIssues()"></td>
                <td><input type="number" id="tmp-${accessRowCount}" placeholder="150" step="1" style="width: 80px;" oninput="analyzeAccessIssues()"></td>
                <td><input type="number" id="fluid-today-${accessRowCount}" placeholder="-1.5" step="0.1" style="width: 80px;" oninput="analyzeAccessIssues()"></td>
                <td><input type="number" id="fluid-total-${accessRowCount}" placeholder="+5.2" step="0.1" style="width: 80px;" oninput="analyzeAccessIssues()"></td>
                <td><input type="number" id="hct-${accessRowCount}" placeholder="35" step="1" min="0" max="100" style="width: 70px;" oninput="analyzeAccessIssues()"></td>
                <td><input type="number" id="ica-${accessRowCount}" placeholder="0.30" step="0.01" min="0" max="3" style="width: 70px;" oninput="analyzeAccessIssues()"></td>
                <td><input type="number" id="antixa-${accessRowCount}" placeholder="0.3" step="0.01" min="0" max="2" style="width: 70px;" oninput="analyzeAccessIssues()"></td>
                <td>
                    <select id="clot-clog-${accessRowCount}" style="width: 100%; min-width: 100px;" onchange="analyzeAccessIssues()">
                        <option value="">None</option>
                        <option value="clot">Yes - Clotting</option>
                        <option value="clog">Yes - Clogging</option>
                        <option value="both">Yes - Both</option>
                    </select>
                </td>
                <td><button onclick="deleteAccessRow(${accessRowCount})" style="background: #DA291C; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; white-space: nowrap;">Delete</button></td>
            `;
        }
        
        // Auto-load first row when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're on the access tab and auto-load first row
            if (document.getElementById('access-monitoring-body').rows.length === 0) {
                addAccessMonitoringRow();
            }
        });
        
        function deleteAccessRow(rowNum) {
            const row = document.getElementById(`access-row-${rowNum}`);
            if (row) {
                row.remove();
                analyzeAccessIssues();
            }
        }
        
        // Analyze Access & Filter Issues
        function analyzeAccessIssues() {
            const alertsDiv = document.getElementById('access-alerts-output');
            const collatedDiv = document.getElementById('access-collated-output');
            const tbody = document.getElementById('access-monitoring-body');
            
            if (tbody.rows.length === 0) {
                alertsDiv.innerHTML = '<p style="text-align: center; color: #666;">Add monitoring data to see alerts</p>';
                collatedDiv.innerHTML = '<p style="text-align: center; color: #666;">Add monitoring data to see recommendations</p>';
                return;
            }
            
            // Get latest row data
            const lastRow = tbody.rows[tbody.rows.length - 1];
            const rowId = lastRow.id.split('-')[2];
            
            const accessPressure = parseFloat(document.getElementById(`access-pressure-${rowId}`)?.value);
            const returnPressure = parseFloat(document.getElementById(`return-pressure-${rowId}`)?.value);
            const tmp = parseFloat(document.getElementById(`tmp-${rowId}`)?.value);
            const fluidToday = parseFloat(document.getElementById(`fluid-today-${rowId}`)?.value);
            const fluidTotal = parseFloat(document.getElementById(`fluid-total-${rowId}`)?.value);
            const hct = parseFloat(document.getElementById(`hct-${rowId}`)?.value);
            const ica = parseFloat(document.getElementById(`ica-${rowId}`)?.value);
            const antiXa = parseFloat(document.getElementById(`antixa-${rowId}`)?.value);
            const clotClog = document.getElementById(`clot-clog-${rowId}`)?.value;
            
            // Get data from Patient & RRT Parameters
            const anticoagMode = document.getElementById('anticoag')?.value;
            const filterType = document.getElementById('filter-type')?.value;
            const filterAgeText = document.getElementById('filter-age-display')?.textContent || '';
            const filterAge = parseInt(filterAgeText);
            
            const alerts = [];
            const actions = new Set(); // Use Set to avoid duplicates
            
            // ALERTS GENERATION
            
            // 1. Citrate anticoagulation alerts
            if (anticoagMode === 'citrate' && !isNaN(ica)) {
                if (ica > 0.35) {
                    alerts.push({
                        severity: 'warning',
                        message: '‚ö†Ô∏è iCa (filter) >0.35 mmol/L - Increased risk of clotting'
                    });
                    actions.add('increase_citrate');
                }
            }
            
            // 2. Heparin anticoagulation alerts
            if (anticoagMode === 'heparin' && !isNaN(antiXa)) {
                if (antiXa < 0.3) {
                    alerts.push({
                        severity: 'warning',
                        message: '‚ö†Ô∏è Anti-Xa <0.3 U/mL - Increased risk of clotting'
                    });
                    actions.add('increase_heparin');
                } else if (antiXa > 0.5) {
                    alerts.push({
                        severity: 'danger',
                        message: 'üö® Anti-Xa >0.5 U/mL - Increased bleeding risk'
                    });
                    actions.add('reduce_heparin');
                }
            }
            
            // 3. High Hct and/or negative fluid balance
            const highHct = !isNaN(hct) && hct > 40;
            const veryNegativeBalance = !isNaN(fluidToday) && fluidToday < -2;
            
            if (highHct || veryNegativeBalance) {
                let msg = '‚ö†Ô∏è ';
                if (highHct && veryNegativeBalance) {
                    msg += 'High Hct AND very negative fluid balance';
                } else if (highHct) {
                    msg += 'High haematocrit (>40%)';
                } else {
                    msg += 'Very negative fluid balance (<-2L today)';
                }
                msg += ' - Consider fluid administration';
                alerts.push({
                    severity: 'warning',
                    message: msg
                });
                actions.add('give_fluid_strong');
            }
            
            // 4. High access pressures
            if (!isNaN(accessPressure) && accessPressure < -200) {
                alerts.push({
                    severity: 'warning',
                    message: `‚ö†Ô∏è High negative access pressure (${accessPressure} mmHg) - Risk of poor flow`
                });
                actions.add('give_fluid');
                actions.add('reduce_blood_flow');
                actions.add('switch_lumens');
            }
            
            // 4b. High return pressure (NEW)
            if (!isNaN(returnPressure) && returnPressure > 250) {
                alerts.push({
                    severity: 'warning',
                    message: `‚ö†Ô∏è High return pressure (${returnPressure} mmHg) - Risk of circuit problems`
                });
                actions.add('check_return_line');
                actions.add('reduce_blood_flow');
            }
            
            // 4c. High TMP alert (NEW)
            if (!isNaN(tmp)) {
                if (tmp > 300) {
                    alerts.push({
                        severity: 'danger',
                        message: `üö® Very high TMP (${tmp} mmHg) - Imminent filter failure`
                    });
                    actions.add('change_filter_urgent');
                } else if (tmp > 250) {
                    alerts.push({
                        severity: 'warning',
                        message: `‚ö†Ô∏è High TMP (${tmp} mmHg) - Filter clogging likely`
                    });
                    actions.add('monitor_tmp_closely');
                    actions.add('check_anticoagulation');
                }
            }
            
            // 5. Filter age >96h with problems
            const oldFilter = filterAge > 96;
            const highPressures = !isNaN(tmp) && tmp > 200;
            const visibleProblems = clotClog && clotClog !== '';
            
            if (oldFilter && (highPressures || visibleProblems)) {
                alerts.push({
                    severity: 'danger',
                    message: 'üö® Filter >96h old WITH high pressures/visible clotting - Filter change strongly recommended'
                });
                actions.add('change_filter_urgent');
            }
            
            // 6. Visible clogging
            if (clotClog === 'clog' || clotClog === 'both') {
                const isEmic2 = filterType && filterType.toLowerCase().includes('emic');
                const isAV1000s = filterType && filterType.toLowerCase().includes('av1000');
                
                alerts.push({
                    severity: 'danger',
                    message: 'üö® Visible filter clogging detected'
                });
                actions.add('give_fluid');
                actions.add('change_filter_urgent');
                
                if (isEmic2) {
                    alerts.push({
                        severity: 'info',
                        message: '‚ÑπÔ∏è EMiC2 filter in use - Expected early clogging in severe inflammatory states'
                    });
                }
                
                // NEW: AV1000s clogging recommendation
                if (isAV1000s) {
                    alerts.push({
                        severity: 'info',
                        message: '‚ÑπÔ∏è Consider switching to EMiC2 filter (larger pore size may reduce clogging)'
                    });
                    actions.add('switch_to_emic2');
                }
            }
            
            // BUILD ALERTS BOX
            let alertsHtml = '<div style="background: white; border: 2px solid var(--nhs-blue); border-radius: 8px; padding: 20px;">';
            alertsHtml += '<h3 style="color: var(--nhs-blue); margin: 0 0 15px 0; font-size: 16px;">Alerts</h3>';
            
            if (alerts.length === 0) {
                alertsHtml += '<p style="color: #007F3B; font-weight: 600; margin: 0;">‚úì No alerts - parameters within acceptable range</p>';
            } else {
                alerts.forEach(alert => {
                    let bgColor, borderColor;
                    if (alert.severity === 'danger') {
                        bgColor = '#FFE5E5';
                        borderColor = '#DA291C';
                    } else if (alert.severity === 'warning') {
                        bgColor = '#FFF4E5';
                        borderColor = '#ED8B00';
                    } else {
                        bgColor = '#E6F2FF';
                        borderColor = '#005EB8';
                    }
                    
                    alertsHtml += `
                        <div style="background: ${bgColor}; border-left: 5px solid ${borderColor}; padding: 12px; margin-bottom: 10px; border-radius: 4px; font-size: 14px;">
                            ${alert.message}
                        </div>
                    `;
                });
            }
            
            alertsHtml += '</div>';
            alertsDiv.innerHTML = alertsHtml;
            
            // BUILD COLLATED MANAGEMENT RECOMMENDATIONS
            let collatedHtml = '<div style="background: white; border: 2px solid var(--nhs-green); border-radius: 8px; padding: 20px;">';
            collatedHtml += '<h3 style="color: var(--nhs-green); margin: 0 0 15px 0; font-size: 16px;">Collated Management Recommendations</h3>';
            
            if (actions.size === 0) {
                collatedHtml += '<p style="color: #007F3B; font-weight: 600; margin: 0;">‚úì No immediate actions required - Continue current management</p>';
            } else {
                collatedHtml += '<p style="font-size: 13px; color: #666; margin: 0 0 15px 0; font-style: italic;">Actions listed in logical order of priority</p>';
                collatedHtml += '<ol style="margin: 0; padding-left: 20px; line-height: 2;">';
                
                // Define action priority and text
                const actionMap = {
                    'give_fluid_strong': {
                        priority: 1,
                        text: '<strong>Give IV fluid bolus</strong> (high Hct and/or very negative balance)',
                        icon: 'üíß'
                    },
                    'give_fluid': {
                        priority: 2,
                        text: '<strong>Consider IV fluid administration</strong> (to improve vascular access pressures)',
                        icon: 'üíß'
                    },
                    'change_filter_urgent': {
                        priority: 3,
                        text: '<strong>Change filter set URGENTLY</strong> (age >96h with problems OR visible clogging OR very high TMP)',
                        icon: 'üî¥'
                    },
                    'increase_citrate': {
                        priority: 4,
                        text: '<strong>Increase citrate dose</strong> (target post-filter iCa 0.25-0.35 mmol/L)',
                        icon: '‚¨ÜÔ∏è'
                    },
                    'increase_heparin': {
                        priority: 5,
                        text: '<strong>Increase heparin infusion</strong> (target anti-Xa 0.3-0.5 U/mL)',
                        icon: '‚¨ÜÔ∏è'
                    },
                    'reduce_heparin': {
                        priority: 6,
                        text: '<strong>Reduce heparin infusion</strong> (anti-Xa >0.5 - bleeding risk)',
                        icon: '‚¨áÔ∏è'
                    },
                    'check_anticoagulation': {
                        priority: 7,
                        text: '<strong>Check anticoagulation levels</strong> (ensure adequate for current settings)',
                        icon: 'üî¨'
                    },
                    'reduce_blood_flow': {
                        priority: 8,
                        text: '<strong>Consider reducing blood flow rate</strong> (if high pressures persist)',
                        icon: '‚¨áÔ∏è'
                    },
                    'check_return_line': {
                        priority: 9,
                        text: '<strong>Check return line</strong> (kinking, positioning, or obstruction)',
                        icon: 'üîç'
                    },
                    'switch_lumens': {
                        priority: 10,
                        text: '<strong>Consider switching access/return lumens</strong> on vascath',
                        icon: 'üîÑ'
                    },
                    'switch_to_emic2': {
                        priority: 11,
                        text: '<strong>Consider switching to EMiC2 filter</strong> (larger pore size may reduce clogging)',
                        icon: 'üîÑ'
                    },
                    'monitor_tmp_closely': {
                        priority: 12,
                        text: '<strong>Monitor TMP closely</strong> (trending upward - prepare for filter change)',
                        icon: 'üëÅÔ∏è'
                    }
                };
                
                // Sort actions by priority and add to list
                Array.from(actions)
                    .sort((a, b) => (actionMap[a]?.priority || 99) - (actionMap[b]?.priority || 99))
                    .forEach(action => {
                        if (actionMap[action]) {
                            collatedHtml += `<li>${actionMap[action].icon} ${actionMap[action].text}</li>`;
                        }
                    });
                
                collatedHtml += '</ol>';
                collatedHtml += '<p style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd; font-size: 13px; color: #666; font-style: italic;">Refer to Alerts box for detailed rationale and specific parameter values</p>';
            }
            
            collatedHtml += '</div>';
            collatedDiv.innerHTML = collatedHtml;
        }
        
        // Calcium Ratio Calculator
        // Calcium Ratio Calculator
        // Global variable for calcium chart
        let calciumChart = null;
        
        function calculateRatio() {
            const totalCa = parseFloat(document.getElementById('total-ca').value);
            const albumin = parseFloat(document.getElementById('serum-albumin').value);
            const ionisedCa = parseFloat(document.getElementById('ionised-ca').value);
            const resultDiv = document.getElementById('ratio-result');
            
            // Validation
            if (!totalCa || !albumin || !ionisedCa) {
                resultDiv.innerHTML = '<p style="color: #666;">Enter all values to calculate</p>';
                if (calciumChart) {
                    calciumChart.destroy();
                    calciumChart = null;
                }
                document.getElementById('calcium-legend').innerHTML = '';
                return;
            }
            
            if (totalCa < 1.0 || totalCa > 4.0) {
                resultDiv.innerHTML = '<p style="color: #DA291C;">Total calcium must be 1.0-4.0 mmol/L</p>';
                return;
            }
            
            if (albumin < 10 || albumin > 60) {
                resultDiv.innerHTML = '<p style="color: #DA291C;">Albumin must be 10-60 g/L</p>';
                return;
            }
            
            if (ionisedCa < 0.5 || ionisedCa > 2.0) {
                resultDiv.innerHTML = '<p style="color: #DA291C;">Ionised calcium must be 0.5-2.0 mmol/L</p>';
                return;
            }
            
            // Calculate adjusted calcium (correction for albumin)
            // Formula: Adjusted Ca = Total Ca + 0.02 √ó (40 - Albumin)
            const adjustedCa = totalCa + 0.02 * (40 - albumin);
            
            // Calculate ratio
            const ratio = totalCa / ionisedCa;
            
            // Determine interpretation
            let interpretation, ratioColor;
            if (ratio < 2.25) {
                interpretation = '‚úì Normal - No citrate accumulation';
                ratioColor = '#007F3B';
            } else if (ratio >= 2.25 && ratio < 2.5) {
                interpretation = '‚ö† Raised - Possible early accumulation';
                ratioColor = '#ED8B00';
            } else {
                interpretation = 'üö® Critical - Strong evidence of accumulation';
                ratioColor = '#DA291C';
            }
            
            // Display results
            resultDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #ddd;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>Total Calcium:</strong></div>
                        <div style="text-align: right;">${totalCa.toFixed(2)} mmol/L</div>
                        
                        <div><strong>Adjusted Calcium:</strong></div>
                        <div style="text-align: right;">${adjustedCa.toFixed(2)} mmol/L</div>
                        
                        <div><strong>Ionised Calcium:</strong></div>
                        <div style="text-align: right;">${ionisedCa.toFixed(2)} mmol/L</div>
                        
                        <div style="border-top: 2px solid #ddd; padding-top: 10px;"><strong>T:I Ratio:</strong></div>
                        <div style="text-align: right; border-top: 2px solid #ddd; padding-top: 10px; font-size: 18px; font-weight: bold; color: ${ratioColor};">${ratio.toFixed(2)}</div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: ${ratioColor.replace('var(--nhs-', 'rgba(').replace(')', ', 0.1)')}; border-radius: 4px; border-left: 3px solid ${ratioColor};">
                        <strong>${interpretation}</strong>
                    </div>
                </div>
            `;
            
            // Calculate calcium components for bar chart
            // Total calcium is divided into:
            // 1. Ionised calcium (measured)
            // 2. Protein-bound calcium (~40% of total normally, adjusted for albumin)
            // 3. Ca-citrate complex (the difference)
            
            // Normal protein-bound Ca is ~40% when albumin = 40 g/L
            // Adjust based on actual albumin: protein-bound = 0.01 √ó albumin √ó total calcium
            const proteinBoundCa = Math.min((0.01 * albumin * totalCa), (totalCa - ionisedCa));
            
            // Ca-citrate complex is the remainder
            const caCitrate = Math.max(0, totalCa - ionisedCa - proteinBoundCa);
            
            // Create/update bar chart
            const ctx = document.getElementById('calcium-bar-chart');
            
            if (calciumChart) {
                calciumChart.destroy();
            }
            
            calciumChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Calcium Distribution'],
                    datasets: [
                        {
                            label: 'Ionised Ca¬≤‚Å∫',
                            data: [ionisedCa],
                            backgroundColor: '#007F3B',
                            borderColor: '#005A2B',
                            borderWidth: 2
                        },
                        {
                            label: 'Protein-bound Ca',
                            data: [proteinBoundCa],
                            backgroundColor: '#005EB8',
                            borderColor: '#003D82',
                            borderWidth: 2
                        },
                        {
                            label: 'Ca-Citrate Complex',
                            data: [caCitrate],
                            backgroundColor: '#DA291C',
                            borderColor: '#A01E15',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Concentration (mmol/L)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            max: Math.max(totalCa * 1.1, 3.0),
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            stacked: true,
                            display: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.x;
                                    const percentage = ((value / totalCa) * 100).toFixed(1);
                                    return `${label}: ${value.toFixed(2)} mmol/L (${percentage}%)`;
                                }
                            },
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            }
                        }
                    }
                }
            });
            
            // Update legend
            const ionisedPercent = ((ionisedCa / totalCa) * 100).toFixed(1);
            const proteinPercent = ((proteinBoundCa / totalCa) * 100).toFixed(1);
            const citratePercent = ((caCitrate / totalCa) * 100).toFixed(1);
            
            document.getElementById('calcium-legend').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div style="background: rgba(0,127,59,0.1); padding: 10px; border-radius: 4px; border-left: 3px solid #007F3B;">
                        <div style="font-weight: 600; color: #007F3B;">Ionised Ca¬≤‚Å∫</div>
                        <div style="font-size: 16px; font-weight: bold;">${ionisedCa.toFixed(2)} mmol/L</div>
                        <div style="font-size: 12px; color: #666;">${ionisedPercent}% of total</div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">Physiologically active</div>
                    </div>
                    <div style="background: rgba(0,94,184,0.1); padding: 10px; border-radius: 4px; border-left: 3px solid #005EB8;">
                        <div style="font-weight: 600; color: #005EB8;">Protein-bound Ca</div>
                        <div style="font-size: 16px; font-weight: bold;">${proteinBoundCa.toFixed(2)} mmol/L</div>
                        <div style="font-size: 12px; color: #666;">${proteinPercent}% of total</div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">Bound to albumin</div>
                    </div>
                    <div style="background: rgba(218,41,28,0.1); padding: 10px; border-radius: 4px; border-left: 3px solid #DA291C;">
                        <div style="font-weight: 600; color: #DA291C;">Ca-Citrate Complex</div>
                        <div style="font-size: 16px; font-weight: bold;">${caCitrate.toFixed(2)} mmol/L</div>
                        <div style="font-size: 12px; color: #666;">${citratePercent}% of total</div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">${caCitrate > 0.5 ? '‚ö†Ô∏è Elevated!' : 'Within range'}</div>
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: rgba(0,94,184,0.05); border-radius: 4px; font-size: 12px;">
                    <strong>Total Calcium = Ionised + Protein-bound + Ca-Citrate</strong><br>
                    ${totalCa.toFixed(2)} = ${ionisedCa.toFixed(2)} + ${proteinBoundCa.toFixed(2)} + ${caCitrate.toFixed(2)} mmol/L
                </div>
            `;
        }
    </script>
</body>
</html>
